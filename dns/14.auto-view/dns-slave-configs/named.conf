//
// named.conf - DNS Slave Server with View support
//

// 定义访问控制列表（ACL）- 与主服务器相同
acl "internal-networks" {
    10.0.0.0/24;        // 内网网段
    localhost;
    localnets;
};

acl "external-networks" {
    192.168.1.0/24;     // 外网网段
    any;                // 其他所有
};

include "/etc/rndc.key";

options {
    //listen-on port 53 { 127.0.0.1; };
    //listen-on-v6 port 53 { ::1; };
    directory     "/var/named";
    dump-file     "/var/named/data/cache_dump.db";
    statistics-file "/var/named/data/named_stats.txt";
    memstatistics-file "/var/named/data/named_mem_stats.txt";
    secroots-file    "/var/named/data/named.secroots";
    recursing-file    "/var/named/data/named.recursing";

    recursion yes;
    dnssec-validation no;

    pid-file "/run/named/named.pid";
};

logging {
    channel default_debug {
        file "data/named.run";
        severity dynamic;
    };
    channel query_log {
        file "/var/log/named/query.log" versions 3 size 10m;
        severity info;
        print-category yes;
        print-severity yes;
        print-time yes;
    };
    category queries {
        query_log;
    };
};

// ========== 内网视图（从服务器）==========
view "internal-view" {
    match-clients { internal-networks; };
    recursion yes;

    zone "." IN {
        type hint;
        file "named.ca";
    };

    zone "magedu.com" IN {
        type slave;                                 // 从服务器类型
        file "slaves/internal-magedu.com.zone";    // 从服务器区域文件路径
        masters { 10.0.0.13; };                    // 主服务器内网 IP
    };

    zone "localhost.localdomain" IN {
        type master;
        file "named.localhost";
        allow-update { none; };
    };

    zone "localhost" IN {
        type master;
        file "named.localhost";
        allow-update { none; };
    };

    zone "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa" IN {
        type master;
        file "named.loopback";
        allow-update { none; };
    };

    zone "1.0.0.127.in-addr.arpa" IN {
        type master;
        file "named.loopback";
        allow-update { none; };
    };

    zone "0.in-addr.arpa" IN {
        type master;
        file "named.empty";
        allow-update { none; };
    };

    include "/etc/named.root.key";
};

// ========== 外网视图（从服务器）==========
view "external-view" {
    match-clients { external-networks; };
    recursion yes;

    zone "." IN {
        type hint;
        file "named.ca";
    };

    zone "magedu.com" IN {
        type slave;                                 // 从服务器类型
        file "slaves/external-magedu.com.zone";    // 从服务器区域文件路径
        masters { 192.168.1.13; };                 // 主服务器外网 IP
    };

    zone "localhost.localdomain" IN {
        type master;
        file "named.localhost";
        allow-update { none; };
    };

    zone "localhost" IN {
        type master;
        file "named.localhost";
        allow-update { none; };
    };

    zone "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa" IN {
        type master;
        file "named.loopback";
        allow-update { none; };
    };

    zone "1.0.0.127.in-addr.arpa" IN {
        type master;
        file "named.loopback";
        allow-update { none; };
    };

    zone "0.in-addr.arpa" IN {
        type master;
        file "named.empty";
        allow-update { none; };
    };

    include "/etc/named.root.key";
};

controls {
    inet * port 953 allow { any; } keys { "rndc-key"; };
};
