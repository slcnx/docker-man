# Rsync + Inotify å®æ—¶åŒæ­¥æµ‹è¯•ç¯å¢ƒ

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æä¾›åŸºäº Docker Compose çš„ **Rsync + Inotify å®æ—¶æ–‡ä»¶åŒæ­¥** æµ‹è¯•ç¯å¢ƒï¼Œç”¨äºå­¦ä¹ å’Œå®è·µ Linux æ–‡ä»¶åŒæ­¥æŠ€æœ¯ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- ç†è§£ Rsync å¢é‡åŒæ­¥åŸç†
- æŒæ¡ Inotify æ–‡ä»¶ç›‘æ§æœºåˆ¶
- é…ç½® SSH å…å¯†ç™»å½•
- å®ç°å®æ—¶æ–‡ä»¶åŒæ­¥
- ç¼–å†™è‡ªåŠ¨åŒ–åŒæ­¥è„šæœ¬

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   rsync-source      â”‚         â”‚   rsync-backup      â”‚
â”‚   (10.0.5.10)       â”‚         â”‚   (10.0.5.11)       â”‚
â”‚                     â”‚         â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ inotifywait  â”‚   â”‚         â”‚  â”‚  SSH Server  â”‚   â”‚
â”‚  â”‚   ç›‘æ§å˜åŒ–   â”‚   â”‚         â”‚  â”‚   æ¥æ”¶æ•°æ®   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚           â”‚         â”‚                     â”‚
â”‚         â†“           â”‚         â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  rsync  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    rsync     â”‚â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  â”‚ /data/backup â”‚   â”‚
â”‚  â”‚ /data/source â”‚   â”‚  sync   â”‚  â”‚              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ç¯å¢ƒ

```bash
cd /root/docker-man/05.å®æ—¶åŒæ­¥/01.manual-rsync_inotify
docker compose up -d
```

### 2. é…ç½® SSH å…å¯†ç™»å½•

```bash
# è¿›å…¥æºç«¯å®¹å™¨
docker compose exec -it rsync-source bash

# ç”Ÿæˆ SSH å¯†é’¥
ssh-keygen -t rsa -b 2048 -N "" -f /root/.ssh/id_rsa

# æŸ¥çœ‹å…¬é’¥
cat /root/.ssh/id_rsa.pub
# å¤åˆ¶è¾“å‡ºå†…å®¹

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿›å…¥å¤‡ä»½ç«¯å®¹å™¨
docker compose exec -it rsync-backup bash

# å®‰è£…å¹¶å¯åŠ¨ SSH æœåŠ¡
yum install -y openssh-server
ssh-keygen -A
/usr/sbin/sshd

# é…ç½®å…¬é’¥
mkdir -p /root/.ssh
chmod 700 /root/.ssh
cat > /root/.ssh/authorized_keys <<'EOF'
[ç²˜è´´æºç«¯çš„å…¬é’¥]
EOF
chmod 600 /root/.ssh/authorized_keys

# è¿”å›æºç«¯æµ‹è¯•è¿æ¥
ssh -o StrictHostKeyChecking=no root@rsync-backup "echo OK"
```

### 3. æµ‹è¯•æ‰‹åŠ¨åŒæ­¥

```bash
# åœ¨æºç«¯å®¹å™¨ä¸­
echo "Test File" > /data/source/test.txt
rsync -avz -e "ssh -o StrictHostKeyChecking=no" /data/source/ root@rsync-backup:/data/backup/

# åœ¨å¤‡ä»½ç«¯éªŒè¯
docker compose exec rsync-backup cat /data/backup/test.txt
```

### 4. å¯åŠ¨å®æ—¶åŒæ­¥

```bash
# åœ¨æºç«¯å®¹å™¨ä¸­åˆ›å»ºåŒæ­¥è„šæœ¬ï¼ˆè§ compose.mdï¼‰
/usr/local/bin/rsync-inotify.sh
```

## ğŸ“š è¯¦ç»†æ–‡æ¡£

è¯·æŸ¥çœ‹ [compose.md](./compose.md) è·å–å®Œæ•´çš„å®è·µæŒ‡å—ã€‚

## ğŸ› ï¸ ä¸»è¦æŠ€æœ¯

- **Rsync**: å¢é‡æ–‡ä»¶åŒæ­¥å·¥å…·
- **Inotify**: Linux å†…æ ¸æ–‡ä»¶ç›‘æ§æœºåˆ¶
- **SSH**: åŠ å¯†ä¼ è¾“åè®®
- **Docker Compose**: å®¹å™¨ç¼–æ’

## ğŸ“ æ³¨æ„äº‹é¡¹

- é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½® SSH å…å¯†ç™»å½•
- ç¡®ä¿å¤‡ä»½ç«¯ SSH æœåŠ¡è¿è¡Œ
- å¤§é‡æ–‡ä»¶ç›‘æ§æ—¶æ³¨æ„ inotify é™åˆ¶
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ›´å®Œå–„çš„åŒæ­¥æ–¹æ¡ˆï¼ˆå¦‚ lsyncdï¼‰

## ğŸ”— ç›¸å…³é¡¹ç›®

- **04.nfs/01.manual-nfs**: NFS ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ
- **03.rsyslog**: æ—¥å¿—ç®¡ç†å®è·µ

---

**ç»´æŠ¤è€…**: docker-man é¡¹ç›®ç»„
**æœ€åæ›´æ–°**: 2025-10-09
