# è‡ªåŠ¨åŒ– Rsync + Inotify å®æ—¶åŒæ­¥è¯¦ç»†æŒ‡å—

## ğŸ“š ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [è‡ªåŠ¨åŒ–åŸç†](#2-è‡ªåŠ¨åŒ–åŸç†)
3. [å¿«é€Ÿå¼€å§‹](#3-å¿«é€Ÿå¼€å§‹)
4. [è‡ªåŠ¨åŒ–æµç¨‹è¯¦è§£](#4-è‡ªåŠ¨åŒ–æµç¨‹è¯¦è§£)
5. [é…ç½®è¯´æ˜](#5-é…ç½®è¯´æ˜)
6. [ç›‘æ§ä¸æ—¥å¿—](#6-ç›‘æ§ä¸æ—¥å¿—)
7. [æ•…éšœæ’æŸ¥](#7-æ•…éšœæ’æŸ¥)
8. [è¿›é˜¶ä½¿ç”¨](#8-è¿›é˜¶ä½¿ç”¨)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯è‡ªåŠ¨åŒ–ç‰ˆæœ¬

æœ¬é¡¹ç›®æ˜¯ `01.manual-rsync_inotify` çš„**å®Œå…¨è‡ªåŠ¨åŒ–ç‰ˆæœ¬**ï¼Œå®ç°äº†ï¼š

- âœ… **é›¶æ‰‹åŠ¨é…ç½®**ï¼š`docker compose up -d` ä¸€é”®å¯åŠ¨
- âœ… **è‡ªåŠ¨ SSH é…ç½®**ï¼šè‡ªåŠ¨ç”Ÿæˆå¯†é’¥ã€è‡ªåŠ¨é…ç½®å…å¯†ç™»å½•
- âœ… **è‡ªåŠ¨æœåŠ¡å‘ç°**ï¼šè‡ªåŠ¨ç­‰å¾…æœåŠ¡å°±ç»ª
- âœ… **è‡ªåŠ¨å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨é‡è¯•ã€è‡ªåŠ¨æ¢å¤
- âœ… **ç”Ÿäº§çº§æ—¥å¿—**ï¼šç»“æ„åŒ–ã€å½©è‰²è¾“å‡º

### 1.2 vs æ‰‹åŠ¨ç‰ˆæœ¬

| ç‰¹æ€§ | 01.manual | 02.auto |
|------|-----------|---------|
| å¯åŠ¨å‘½ä»¤ | å¤šæ­¥æ‰‹åŠ¨æ“ä½œ | `docker compose up -d` |
| SSH é…ç½® | æ‰‹åŠ¨ç”Ÿæˆã€æ‰‹åŠ¨å¤åˆ¶ | è‡ªåŠ¨é€šè¿‡å…±äº«å·äº¤æ¢ |
| æœåŠ¡æ£€æŸ¥ | æ‰‹åŠ¨æµ‹è¯• | è‡ªåŠ¨ç­‰å¾… + é‡è¯• |
| é€‚ç”¨åœºæ™¯ | å­¦ä¹ ã€ç†è§£åŸç† | ç”Ÿäº§ç¯å¢ƒã€CI/CD |
| å­¦ä¹ æ›²çº¿ | é«˜ï¼ˆéœ€ç†è§£æ¯ä¸€æ­¥ï¼‰ | ä½ï¼ˆå¼€ç®±å³ç”¨ï¼‰ |

---

## 2. è‡ªåŠ¨åŒ–åŸç†

### 2.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Docker Compose ç¼–æ’                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  rsync-source     â”‚                    â”‚  rsync-backup     â”‚
â”‚  (10.0.5.10)      â”‚                    â”‚  (10.0.5.11)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ rsync-inotify.sh  â”‚                    â”‚ start-sshd.sh     â”‚
â”‚                   â”‚                    â”‚                   â”‚
â”‚ 1ï¸âƒ£ ç”Ÿæˆ SSH å¯†é’¥  â”‚                    â”‚ 1ï¸âƒ£ å¯åŠ¨ SSH æœåŠ¡  â”‚
â”‚ 2ï¸âƒ£ å…±äº«å…¬é’¥       â”‚â”€â”€â”€â”€â”€ ssh-keys â”€â”€â”€â”€â†’â”‚ 2ï¸âƒ£ è¯»å–å…¬é’¥       â”‚
â”‚ 3ï¸âƒ£ ç­‰å¾… SSH å°±ç»ª  â”‚      (å…±äº«å·)      â”‚ 3ï¸âƒ£ é…ç½® authorized_keysâ”‚
â”‚ 4ï¸âƒ£ æµ‹è¯• SSH è¿æ¥  â”‚                    â”‚ 4ï¸âƒ£ ç›‘æ§å…¬é’¥æ›´æ–°   â”‚
â”‚ 5ï¸âƒ£ é¦–æ¬¡å…¨é‡åŒæ­¥   â”‚                    â”‚                   â”‚
â”‚ 6ï¸âƒ£ å®æ—¶ç›‘æ§åŒæ­¥   â”‚                    â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å…³é”®æŠ€æœ¯

#### 2.2.1 å…±äº«å·è‡ªåŠ¨äº¤æ¢å¯†é’¥

```yaml
volumes:
  - ssh-keys:/shared-keys     # ä¸¤ä¸ªå®¹å™¨å…±äº«æ­¤å·
```

**å·¥ä½œæµç¨‹**ï¼š
1. **æºç«¯**ï¼šç”Ÿæˆ `id_rsa` å’Œ `id_rsa.pub`
2. **æºç«¯**ï¼šå°† `id_rsa.pub` å¤åˆ¶åˆ° `/shared-keys/`
3. **å¤‡ä»½ç«¯**ï¼šä» `/shared-keys/` è¯»å–å…¬é’¥
4. **å¤‡ä»½ç«¯**ï¼šå†™å…¥ `/root/.ssh/authorized_keys`

#### 2.2.2 æœåŠ¡ä¾èµ–ä¸ç­‰å¾…

```yaml
depends_on:
  - rsync-backup
```

```bash
# åœ¨è„šæœ¬ä¸­å®ç°æ™ºèƒ½ç­‰å¾…
while [ $retries -lt $MAX_RETRIES ]; do
    if nc -z ${DEST_HOST} 22 2>/dev/null; then
        break
    fi
    sleep 5
done
```

#### 2.2.3 ç¯å¢ƒå˜é‡é…ç½®

```yaml
environment:
  - DEST_HOST=rsync-backup
  - SYNC_INTERVAL=5
  - MAX_RETRIES=10
```

---

## 3. å¿«é€Ÿå¼€å§‹

### 3.1 ä¸€é”®å¯åŠ¨

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/docker-man/05.realtime-sync/02.auto-rsync_inotify

# 2. å¯åŠ¨ï¼ˆè‡ªåŠ¨æ„å»º + é…ç½® + è¿è¡Œï¼‰
docker compose up -d

# 3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker compose logs -f
```

### 3.2 éªŒè¯è¿è¡Œ

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker compose ps

# é¢„æœŸè¾“å‡ºï¼š
# NAME            IMAGE                  STATUS
# rsync-backup    rsync-inotify:latest   Up
# rsync-source    rsync-inotify:latest   Up

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker compose logs -f rsync-source
```

### 3.3 æµ‹è¯•åŒæ­¥

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
docker compose exec rsync-source bash -c "echo 'Hello Auto Sync' > /data/source/test.txt"

# ç­‰å¾… 5 ç§’ï¼ˆSYNC_INTERVALï¼‰ï¼ŒæŸ¥çœ‹æ—¥å¿—
docker compose logs rsync-source | tail -20

# éªŒè¯åŒæ­¥ç»“æœ
docker compose exec rsync-backup cat /data/backup/test.txt
# è¾“å‡ºï¼šHello Auto Sync
```

---

## 4. è‡ªåŠ¨åŒ–æµç¨‹è¯¦è§£

### 4.1 å¯åŠ¨é˜¶æ®µ

#### æ­¥éª¤ 1ï¼šé•œåƒæ„å»º

```bash
# Docker Compose è‡ªåŠ¨æ‰§è¡Œ
docker build -f ../rsync_inotify.dockerfile -t rsync-inotify:latest ..
```

**Dockerfile å†…å®¹**ï¼ˆå‚è€ƒ `../rsync_inotify.dockerfile`ï¼‰ï¼š
- åŸºäº Ubuntu/Alpine
- å®‰è£… rsyncã€inotify-toolsã€openssh-server
- é…ç½®å·¥ä½œç›®å½•

#### æ­¥éª¤ 2ï¼šå®¹å™¨å¯åŠ¨

```bash
# æŒ‰ depends_on é¡ºåºå¯åŠ¨
1. rsync-backup (å¤‡ä»½ç«¯å…ˆå¯åŠ¨)
2. rsync-source (æºç«¯åå¯åŠ¨)
```

#### æ­¥éª¤ 3ï¼šå¤‡ä»½ç«¯åˆå§‹åŒ– (start-sshd.sh)

```
[2025-10-09 12:00:00] ==========================================
[2025-10-09 12:00:00] SSH æœåŠ¡å™¨ - è‡ªåŠ¨é…ç½®å¯åŠ¨
[2025-10-09 12:00:00] ==========================================
[2025-10-09 12:00:00] ç”Ÿæˆ SSH ä¸»æœºå¯†é’¥...
[2025-10-09 12:00:01] SSH ä¸»æœºå¯†é’¥ç”Ÿæˆå®Œæˆ âœ“
[2025-10-09 12:00:01] é…ç½® SSH æœåŠ¡...
[2025-10-09 12:00:01] SSH é…ç½®å®Œæˆ âœ“
[2025-10-09 12:00:01] ç­‰å¾…æºç«¯å…¬é’¥...
[INFO 2025-10-09 12:00:01] ç­‰å¾…æºç«¯ç”Ÿæˆå…¬é’¥... (1/30)
[2025-10-09 12:00:05] å‘ç°æºç«¯å…¬é’¥ï¼Œé…ç½®æˆæƒ...
[2025-10-09 12:00:05] SSH å…å¯†ç™»å½•é…ç½®å®Œæˆ âœ“
[2025-10-09 12:00:05] å¯åŠ¨ SSH æœåŠ¡...
[2025-10-09 12:00:05] SSH æœåŠ¡å·²å¯åŠ¨ âœ“
[2025-10-09 12:00:05]   PID: 123
[2025-10-09 12:00:05]   ç«¯å£: 22
[2025-10-09 12:00:05]   ä¸»æœºå: rsync-backup
[2025-10-09 12:00:05]   IP åœ°å€: 10.0.5.11
[2025-10-09 12:00:05] ==========================================
[2025-10-09 12:00:05] SSH æœåŠ¡å™¨å°±ç»ªï¼Œç­‰å¾…è¿æ¥...
[2025-10-09 12:00:05] ==========================================
```

#### æ­¥éª¤ 4ï¼šæºç«¯åˆå§‹åŒ– (rsync-inotify.sh)

```
[2025-10-09 12:00:05] ==========================================
[2025-10-09 12:00:05] Rsync + Inotify è‡ªåŠ¨åŒ–å®æ—¶åŒæ­¥æœåŠ¡
[2025-10-09 12:00:05] ==========================================
[2025-10-09 12:00:05] ç‰ˆæœ¬: è‡ªåŠ¨åŒ– v1.0
[2025-10-09 12:00:05] é…ç½®ä¿¡æ¯ï¼š
[2025-10-09 12:00:05]   æºç›®å½•: /data/source/
[2025-10-09 12:00:05]   ç›®æ ‡ä¸»æœº: rsync-backup
[2025-10-09 12:00:05]   ç›®æ ‡ç›®å½•: /data/backup/
[2025-10-09 12:00:05]   Rsync é€‰é¡¹: -avz --delete
[2025-10-09 12:00:05]   åŒæ­¥é—´éš”: 5ç§’
[2025-10-09 12:00:05]   æœ€å¤§é‡è¯•: 10æ¬¡
[2025-10-09 12:00:05] ==========================================
[2025-10-09 12:00:05] ==========================================
[2025-10-09 12:00:05] é…ç½® SSH å¯†é’¥ï¼ˆè‡ªåŠ¨åŒ–ï¼‰
[2025-10-09 12:00:05] ==========================================
[2025-10-09 12:00:05] ç”Ÿæˆ SSH å¯†é’¥å¯¹...
[2025-10-09 12:00:06] SSH å¯†é’¥ç”Ÿæˆå®Œæˆ âœ“
[2025-10-09 12:00:06] å…±äº«å…¬é’¥åˆ°å¤‡ä»½æœåŠ¡å™¨...
[2025-10-09 12:00:06] å…¬é’¥å·²å…±äº« âœ“
[2025-10-09 12:00:06] ==========================================
[2025-10-09 12:00:06] ç­‰å¾… SSH æœåŠ¡å°±ç»ª
[2025-10-09 12:00:06] ==========================================
[2025-10-09 12:00:06] ç›®æ ‡ä¸»æœº: rsync-backup:22
[2025-10-09 12:00:06] SSH æœåŠ¡å·²å°±ç»ª âœ“
[2025-10-09 12:00:09] ==========================================
[2025-10-09 12:00:09] æµ‹è¯• SSH è¿æ¥
[2025-10-09 12:00:09] ==========================================
[2025-10-09 12:00:10] SSH å…å¯†ç™»å½•æµ‹è¯•æˆåŠŸ âœ“
[2025-10-09 12:00:10] ==========================================
[2025-10-09 12:00:10] é¦–æ¬¡å…¨é‡åŒæ­¥
[2025-10-09 12:00:10] ==========================================
[2025-10-09 12:00:11] åŒæ­¥æˆåŠŸ (è€—æ—¶: 1ç§’) âœ“
[2025-10-09 12:00:11] é¦–æ¬¡å…¨é‡åŒæ­¥å®Œæˆ âœ“
[2025-10-09 12:00:11] ==========================================
[2025-10-09 12:00:11] å®æ—¶ç›‘æ§å·²å¯åŠ¨
[2025-10-09 12:00:11] ==========================================
[2025-10-09 12:00:11] ç›‘æ§ç›®å½•: /data/source/
[2025-10-09 12:00:11] æ‰¹é‡åŒæ­¥é—´éš”: 5ç§’
[2025-10-09 12:00:11] ç›‘æ§äº‹ä»¶: CREATE, MODIFY, DELETE, MOVED_TO, CLOSE_WRITE
[2025-10-09 12:00:11] ==========================================
[2025-10-09 12:00:11] âœ“ æœåŠ¡è¿è¡Œä¸­ï¼Œå®æ—¶ç›‘æ§æ–‡ä»¶å˜åŒ–...
```

### 4.2 è¿è¡Œé˜¶æ®µ

#### æ–‡ä»¶å˜åŒ–è§¦å‘åŒæ­¥

```
[INFO 2025-10-09 12:05:00] æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–: /data/source/test.txt CLOSE_WRITE,CLOSE
[2025-10-09 12:05:05] è§¦å‘æ‰¹é‡åŒæ­¥...
[2025-10-09 12:05:06] åŒæ­¥æˆåŠŸ (è€—æ—¶: 1ç§’) âœ“
```

#### æ‰¹é‡åŒæ­¥æœºåˆ¶

```bash
# åœ¨ 5 ç§’é—´éš”å†…çš„å¤šä¸ªæ–‡ä»¶å˜åŒ–ï¼Œåˆå¹¶ä¸ºä¸€æ¬¡åŒæ­¥
CHANGED=0
LAST_SYNC=$(date +%s)

while read line; do
    CHANGED=1
    NOW=$(date +%s)
    ELAPSED=$((NOW - LAST_SYNC))

    if [ $CHANGED -eq 1 ] && [ $ELAPSED -ge 5 ]; then
        do_sync
        CHANGED=0
        LAST_SYNC=$(date +%s)
    fi
done
```

---

## 5. é…ç½®è¯´æ˜

### 5.1 ç¯å¢ƒå˜é‡å®Œæ•´åˆ—è¡¨

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|----------|------|--------|------|
| `SOURCE_DIR` | æºç›®å½•è·¯å¾„ | `/data/source/` | `/data/web/` |
| `DEST_HOST` | ç›®æ ‡ä¸»æœºå | `rsync-backup` | `backup-server` |
| `DEST_DIR` | ç›®æ ‡ç›®å½•è·¯å¾„ | `/data/backup/` | `/backup/web/` |
| `RSYNC_OPTS` | Rsync é€‰é¡¹ | `-avz --delete` | `-avzh --progress` |
| `SSH_OPTS` | SSH é€‰é¡¹ | `-o StrictHostKeyChecking=no` | `-p 2222` |
| `SYNC_INTERVAL` | åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰ | `5` | `10` |
| `MAX_RETRIES` | æœ€å¤§é‡è¯•æ¬¡æ•° | `10` | `20` |

### 5.2 ä¿®æ”¹é…ç½®

#### æ–¹æ³• 1ï¼šä¿®æ”¹ compose.yml

```yaml
environment:
  - SYNC_INTERVAL=10        # æ”¹ä¸º 10 ç§’é—´éš”
  - RSYNC_OPTS=-avz         # ç§»é™¤ --delete é€‰é¡¹
```

#### æ–¹æ³• 2ï¼šä½¿ç”¨ .env æ–‡ä»¶

```bash
# åˆ›å»º .env æ–‡ä»¶
cat > .env <<'EOF'
SYNC_INTERVAL=10
RSYNC_OPTS=-avz
MAX_RETRIES=20
EOF

# é‡å¯æœåŠ¡
docker compose down && docker compose up -d
```

### 5.3 å¸¸ç”¨é…ç½®åœºæ™¯

#### åœºæ™¯ 1ï¼šé«˜é¢‘åŒæ­¥ï¼ˆå®æ—¶æ€§è¦æ±‚é«˜ï¼‰

```yaml
environment:
  - SYNC_INTERVAL=1         # 1 ç§’é—´éš”
```

#### åœºæ™¯ 2ï¼šä½é¢‘åŒæ­¥ï¼ˆå‡å°‘ I/Oï¼‰

```yaml
environment:
  - SYNC_INTERVAL=30        # 30 ç§’é—´éš”
```

#### åœºæ™¯ 3ï¼šä»…å¢é‡ä¸åˆ é™¤

```yaml
environment:
  - RSYNC_OPTS=-avz         # ç§»é™¤ --delete
```

#### åœºæ™¯ 4ï¼šé™åˆ¶å¸¦å®½

```yaml
environment:
  - RSYNC_OPTS=-avz --delete --bwlimit=5120  # é™é€Ÿ 5MB/s
```

---

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 å®æ—¶æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose logs -f

# ä»…æŸ¥çœ‹æºç«¯ï¼ˆåŒæ­¥æ—¥å¿—ï¼‰
docker compose logs -f rsync-source

# ä»…æŸ¥çœ‹å¤‡ä»½ç«¯ï¼ˆSSH æœåŠ¡æ—¥å¿—ï¼‰
docker compose logs -f rsync-backup

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker compose logs --tail=100

# æŸ¥çœ‹å¸¦æ—¶é—´æˆ³
docker compose logs -f -t
```

### 6.2 æ—¥å¿—çº§åˆ«

| çº§åˆ« | é¢œè‰² | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| **LOG** | ğŸŸ¢ ç»¿è‰² | æ­£å¸¸æ“ä½œ | `[2025-10-09 12:00:00] åŒæ­¥æˆåŠŸ âœ“` |
| **INFO** | ğŸ”µ è“è‰² | ä¿¡æ¯æç¤º | `[INFO] æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–` |
| **WARN** | ğŸŸ¡ é»„è‰² | è­¦å‘Šï¼ˆå¯ç»§ç»­ï¼‰ | `[WARN] SSH è¿æ¥é‡è¯•...` |
| **ERROR** | ğŸ”´ çº¢è‰² | é”™è¯¯ï¼ˆä¸¥é‡ï¼‰ | `[ERROR] åŒæ­¥å¤±è´¥` |

### 6.3 å…³é”®æ—¥å¿—

#### æˆåŠŸå¯åŠ¨æ ‡å¿—

```
âœ“ æœåŠ¡è¿è¡Œä¸­ï¼Œå®æ—¶ç›‘æ§æ–‡ä»¶å˜åŒ–...
```

#### åŒæ­¥æˆåŠŸ

```
[2025-10-09 12:00:00] åŒæ­¥æˆåŠŸ (è€—æ—¶: 1ç§’) âœ“
```

#### æ£€æµ‹åˆ°å˜åŒ–

```
[INFO 2025-10-09 12:00:00] æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–: /data/source/test.txt
```

---

## 7. æ•…éšœæ’æŸ¥

### 7.1 æœåŠ¡æ— æ³•å¯åŠ¨

#### é—®é¢˜ï¼šå®¹å™¨ç«‹å³é€€å‡º

```bash
# æ£€æŸ¥é€€å‡ºåŸå› 
docker compose ps
docker compose logs rsync-source
docker compose logs rsync-backup
```

**å¯èƒ½åŸå› **ï¼š
1. è„šæœ¬æƒé™é—®é¢˜
2. Dockerfile æ„å»ºå¤±è´¥
3. ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
```bash
# 1. æ£€æŸ¥è„šæœ¬æƒé™
ls -l scripts/
chmod +x scripts/*.sh

# 2. é‡æ–°æ„å»ºé•œåƒ
docker compose build --no-cache

# 3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose up
```

### 7.2 SSH è¿æ¥å¤±è´¥

#### é—®é¢˜ï¼šSSH connection test failed

```bash
# æŸ¥çœ‹å¤‡ä»½ç«¯æ˜¯å¦æ­£å¸¸è¿è¡Œ
docker compose ps rsync-backup

# æ‰‹åŠ¨æµ‹è¯• SSH
docker compose exec rsync-source nc -zv rsync-backup 22

# æ£€æŸ¥å…¬é’¥æ˜¯å¦å…±äº«
docker compose exec rsync-source ls -l /shared-keys/
docker compose exec rsync-backup ls -l /root/.ssh/authorized_keys
```

### 7.3 åŒæ­¥ä¸å·¥ä½œ

#### é—®é¢˜ï¼šæ–‡ä»¶åˆ›å»ºäº†ä½†æœªåŒæ­¥

```bash
# æ£€æŸ¥ inotify æ˜¯å¦è¿è¡Œ
docker compose exec rsync-source ps aux | grep inotify

# æ£€æŸ¥æ–‡ä»¶å˜åŒ–æ˜¯å¦è¢«æ£€æµ‹åˆ°
docker compose logs rsync-source | grep "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"

# æ‰‹åŠ¨è§¦å‘åŒæ­¥æµ‹è¯•
docker compose exec rsync-source rsync -avz /data/source/ root@rsync-backup:/data/backup/
```

### 7.4 å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ | è§£å†³æ–¹æ³• |
|--------|------|----------|
| 255 | SSH è¿æ¥å¤±è´¥ | æ£€æŸ¥ SSH æœåŠ¡ã€å¯†é’¥é…ç½® |
| 23 | éƒ¨åˆ†æ–‡ä»¶ä¼ è¾“å¤±è´¥ | æ£€æŸ¥æƒé™ã€ç£ç›˜ç©ºé—´ |
| 12 | åè®®ç‰ˆæœ¬ä¸åŒ¹é… | æ£€æŸ¥ rsync ç‰ˆæœ¬ |

---

## 8. è¿›é˜¶ä½¿ç”¨

### 8.1 æŒä¹…åŒ–å­˜å‚¨

å°† Docker Volume æ”¹ä¸ºå®¿ä¸»æœºç›®å½•ï¼š

```yaml
volumes:
  # - source-data:/data/source      # æ³¨é‡Šæ‰ Volume
  - /path/on/host/source:/data/source   # æŒ‚è½½å®¿ä¸»æœºç›®å½•
```

### 8.2 å¤šç›®æ ‡åŒæ­¥

ä¿®æ”¹è„šæœ¬æ”¯æŒå¤šä¸ªå¤‡ä»½ç›®æ ‡ï¼š

```bash
# åœ¨ rsync-inotify.sh ä¸­æ·»åŠ 
DEST_HOSTS=("rsync-backup1" "rsync-backup2")

for host in "${DEST_HOSTS[@]}"; do
    rsync -avz /data/source/ root@${host}:/data/backup/
done
```

### 8.3 æ—¥å¿—æŒä¹…åŒ–

æ·»åŠ æ—¥å¿—æ–‡ä»¶è¾“å‡ºï¼š

```yaml
volumes:
  - ./logs:/var/log/rsync
```

```bash
# åœ¨è„šæœ¬ä¸­æ·»åŠ 
exec 1> >(tee -a /var/log/rsync/sync.log)
exec 2>&1
```

### 8.4 ç›‘æ§é›†æˆ

æ·»åŠ  Prometheus æŒ‡æ ‡ï¼š

```bash
# å¯¼å‡ºåŒæ­¥æ¬¡æ•°ã€å¤±è´¥æ¬¡æ•°ç­‰æŒ‡æ ‡
echo "rsync_sync_total ${SYNC_COUNT}" > /var/metrics/rsync.prom
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿå…¥é—¨](README.md)
- [Rsync é€‰é¡¹å‚è€ƒ](../rsync_inotify.md)
- [æ‰‹åŠ¨ç‰ˆæœ¬å¯¹æ¯”](../01.manual-rsync_inotify/)
- [Dockerfile æºç ](../rsync_inotify.dockerfile)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-10-09
**ç»´æŠ¤è€…**: docker-man é¡¹ç›®ç»„
