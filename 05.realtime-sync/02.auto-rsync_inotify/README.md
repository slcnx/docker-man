# 02. è‡ªåŠ¨åŒ– Rsync + Inotify å®æ—¶åŒæ­¥

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ `01.manual-rsync_inotify` çš„**è‡ªåŠ¨åŒ–ç‰ˆæœ¬**ï¼Œå®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨é…ç½®å¹¶è¿è¡Œå®æ—¶åŒæ­¥æœåŠ¡ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- âœ… **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šå®¹å™¨å¯åŠ¨è‡ªåŠ¨è¿è¡ŒåŒæ­¥è„šæœ¬
- âœ… **è‡ªåŠ¨é…ç½® SSH**ï¼šè‡ªåŠ¨ç”Ÿæˆå¯†é’¥ã€é…ç½®å…å¯†ç™»å½•
- âœ… **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨ç­‰å¾…æœåŠ¡å°±ç»ª
- âœ… **æ‰¹é‡åŒæ­¥**ï¼š5ç§’é—´éš”æ‰¹é‡åŒæ­¥ï¼Œå‡å°‘ I/O
- âœ… **å½©è‰²æ—¥å¿—**ï¼šæ¸…æ™°çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºç›‘æ§
- âœ… **ç¯å¢ƒå˜é‡é…ç½®**ï¼šçµæ´»çš„é…ç½®æ–¹å¼
- âœ… **è‡ªåŠ¨é‡å¯**ï¼šæœåŠ¡å¼‚å¸¸è‡ªåŠ¨é‡å¯

## ğŸ†š ä¸ 01 ç‰ˆæœ¬çš„åŒºåˆ«

| ç‰¹æ€§ | 01.manual | 02.auto |
|------|-----------|---------|
| **å¯åŠ¨æ–¹å¼** | æ‰‹åŠ¨è¿›å…¥å®¹å™¨æ‰§è¡Œå‘½ä»¤ | å®¹å™¨è‡ªåŠ¨è¿è¡Œ |
| **SSH é…ç½®** | æ‰‹åŠ¨é…ç½® | è‡ªåŠ¨é…ç½® |
| **é€‚ç”¨åœºæ™¯** | å­¦ä¹ å®è·µã€æ‰‹åŠ¨æ§åˆ¶ | ç”Ÿäº§ç¯å¢ƒã€è‡ªåŠ¨åŒ– |
| **æ“ä½œå¤æ‚åº¦** | é«˜ï¼ˆéœ€å¤šæ­¥æ“ä½œï¼‰ | ä½ï¼ˆä¸€é”®å¯åŠ¨ï¼‰ |
| **æ—¥å¿—è¾“å‡º** | ç®€å• | å½©è‰²ã€ç»“æ„åŒ– |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æœåŠ¡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/docker-man/05.realtime-sync/02.auto-rsync_inotify

# é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨æ„å»ºé•œåƒï¼ˆä½¿ç”¨ä¸Šçº§ç›®å½•çš„ rsync_inotify.dockerfileï¼‰
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—ï¼ˆè§‚å¯Ÿè‡ªåŠ¨åŒ–é…ç½®è¿‡ç¨‹ï¼‰
docker compose logs -f rsync-source

# æŸ¥çœ‹å¤‡ä»½ç«¯æ—¥å¿—
docker compose logs -f rsync-backup
```

**è¯´æ˜**ï¼š
- Docker Compose ä¼šè‡ªåŠ¨ä½¿ç”¨ `../rsync_inotify.dockerfile` æ„å»ºé•œåƒ
- é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦ 1-2 åˆ†é’Ÿæ„å»ºé•œåƒ
- å®¹å™¨å¯åŠ¨åä¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰é…ç½®ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„

### 2. æµ‹è¯•åŒæ­¥

```bash
# åˆ›å»ºæµ‹è¯•æ–‡ä»¶
docker compose exec rsync-source bash -c "echo 'Test File' > /data/source/test.txt"

# æŸ¥çœ‹åŒæ­¥æ—¥å¿—ï¼ˆåº”è¯¥åœ¨5ç§’å†…è‡ªåŠ¨åŒæ­¥ï¼‰
docker compose logs -f rsync-source

# éªŒè¯åŒæ­¥ç»“æœ
docker compose exec rsync-backup cat /data/backup/test.txt
```

### 3. åœæ­¢æœåŠ¡

```bash
docker compose down

# å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬æ•°æ®å·ï¼‰
docker compose down --volumes
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
02.auto-rsync_inotify/
â”œâ”€â”€ compose.yml              # Docker Compose é…ç½®
â”œâ”€â”€ README.md               # æœ¬æ–‡ä»¶
â”œâ”€â”€ compose.md              # è¯¦ç»†æ–‡æ¡£
â””â”€â”€ scripts/
    â”œâ”€â”€ rsync-inotify.sh    # å®æ—¶åŒæ­¥è„šæœ¬
    â””â”€â”€ start-sshd.sh       # SSH æœåŠ¡å¯åŠ¨è„šæœ¬
```

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `compose.yml` ä¸­å¯ä»¥é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

| å˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `SOURCE_DIR` | æºç›®å½• | `/data/source/` |
| `DEST_HOST` | ç›®æ ‡ä¸»æœº | `rsync-backup` |
| `DEST_DIR` | ç›®æ ‡ç›®å½• | `/data/backup/` |
| `RSYNC_OPTS` | Rsync é€‰é¡¹ | `-avz --delete` |
| `SSH_OPTS` | SSH é€‰é¡¹ | `-o StrictHostKeyChecking=no` |
| `SYNC_INTERVAL` | åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰ | `5` |
| `MAX_RETRIES` | æœ€å¤§é‡è¯•æ¬¡æ•° | `5` |

## ğŸ“Š ç›‘æ§æ—¥å¿—

### æŸ¥çœ‹å®æ—¶æ—¥å¿—

```bash
# æŸ¥çœ‹æºç«¯æ—¥å¿—ï¼ˆåŒæ­¥è¿‡ç¨‹ï¼‰
docker compose logs -f rsync-source

# æŸ¥çœ‹å¤‡ä»½ç«¯æ—¥å¿—ï¼ˆSSH æœåŠ¡ï¼‰
docker compose logs -f rsync-backup
```

### æ—¥å¿—ç¤ºä¾‹

```
[2025-10-09 12:00:00] ==========================================
[2025-10-09 12:00:00] Rsync + Inotify å®æ—¶åŒæ­¥æœåŠ¡
[2025-10-09 12:00:00] ==========================================
[2025-10-09 12:00:00] é…ç½®ä¿¡æ¯ï¼š
[2025-10-09 12:00:00]   æºç›®å½•: /data/source/
[2025-10-09 12:00:00]   ç›®æ ‡ä¸»æœº: rsync-backup
[2025-10-09 12:00:00]   ç›®æ ‡ç›®å½•: /data/backup/
[2025-10-09 12:00:00]   Rsync é€‰é¡¹: -avz --delete
[2025-10-09 12:00:00]   åŒæ­¥é—´éš”: 5ç§’
[2025-10-09 12:00:00] ==========================================
[2025-10-09 12:00:01] ç­‰å¾… SSH æœåŠ¡ rsync-backup:22 å°±ç»ª...
[2025-10-09 12:00:02] SSH æœåŠ¡å·²å°±ç»ª
[2025-10-09 12:00:03] SSH å…å¯†ç™»å½•é…ç½®æˆåŠŸ âœ“
[2025-10-09 12:00:04] å¼€å§‹é¦–æ¬¡å…¨é‡åŒæ­¥...
[2025-10-09 12:00:05] åŒæ­¥æˆåŠŸ (è€—æ—¶: 1ç§’) âœ“
[2025-10-09 12:00:05] å¯åŠ¨å®æ—¶ç›‘æ§ /data/source/
[2025-10-09 12:00:05] æœåŠ¡è¿è¡Œä¸­... (Ctrl+C åœæ­¢)
[INFO 2025-10-09 12:01:00] æ£€æµ‹åˆ°å˜åŒ–: /data/source/test.txt CLOSE_WRITE,CLOSE
[2025-10-09 12:01:05] è§¦å‘æ‰¹é‡åŒæ­¥...
[2025-10-09 12:01:06] åŒæ­¥æˆåŠŸ (è€—æ—¶: 1ç§’) âœ“
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker compose ps

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs

# é‡æ–°æ„å»ºé•œåƒ
cd /root/docker-man/05.realtime-sync
docker build -t rsync-inotify:latest -f rsync_inotify.dockerfile .
```

### é—®é¢˜ 2ï¼šåŒæ­¥ä¸å·¥ä½œ

```bash
# æ£€æŸ¥æºç«¯æ—¥å¿—
docker compose logs rsync-source

# æ£€æŸ¥ SSH è¿æ¥
docker compose exec rsync-source ssh -o StrictHostKeyChecking=no root@rsync-backup "echo OK"

# æ‰‹åŠ¨è§¦å‘åŒæ­¥æµ‹è¯•
docker compose exec rsync-source rsync -avz /data/source/ root@rsync-backup:/data/backup/
```

### é—®é¢˜ 3ï¼šæƒé™é—®é¢˜

```bash
# æ£€æŸ¥è„šæœ¬æƒé™
ls -l scripts/

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/*.sh
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯¦ç»†æ“ä½œæŒ‡å—](compose.md) - å®Œæ•´çš„ä½¿ç”¨è¯´æ˜
- [Rsync å‘½ä»¤é€‰é¡¹](../rsync_inotify.md) - Rsync é€‰é¡¹å‚è€ƒ
- [01.manual ç‰ˆæœ¬](../01.manual-rsync_inotify/) - æ‰‹åŠ¨ç‰ˆæœ¬å¯¹æ¯”å­¦ä¹ 

## ğŸ“ å­¦ä¹ è·¯å¾„

1. **åˆå­¦è€…**ï¼šå…ˆå­¦ä¹  `01.manual-rsync_inotify`ï¼Œç†è§£åŸç†
2. **è¿›é˜¶**ï¼šå­¦ä¹ æœ¬é¡¹ç›®ï¼Œäº†è§£è‡ªåŠ¨åŒ–å®ç°
3. **ç”Ÿäº§**ï¼šæ ¹æ®éœ€æ±‚è°ƒæ•´é…ç½®ï¼Œéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

## ğŸ’¡ ç”Ÿäº§ç¯å¢ƒå»ºè®®

- âœ… ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨æŒ‚è½½ï¼ˆè€Œé Volumeï¼‰
- âœ… é…ç½®æ—¥å¿—è½®è½¬é¿å…æ—¥å¿—è¿‡å¤§
- âœ… æ ¹æ®ç½‘ç»œå¸¦å®½è°ƒæ•´ `SYNC_INTERVAL`
- âœ… æ·»åŠ ç›‘æ§å‘Šè­¦ï¼ˆPrometheus + Grafanaï¼‰
- âœ… å®šæœŸæ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2025-10-09**: åˆå§‹ç‰ˆæœ¬å‘å¸ƒ

---

**é¡¹ç›®è·¯å¾„**: `/root/docker-man/05.realtime-sync/02.auto-rsync_inotify/`
**ç»´æŠ¤è€…**: docker-man é¡¹ç›®ç»„
