# Docker Compose NFS å®Œæ•´å®è·µæŒ‡å—

## ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€çŸ¥è¯†

### 1.1 ä»€ä¹ˆæ˜¯ NFSï¼ˆNetwork File Systemï¼‰

NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰æ˜¯ä¸€ç§**åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿåè®®**ï¼Œå…è®¸å®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œè®¿é—®è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œå°±åƒè®¿é—®æœ¬åœ°æ–‡ä»¶ä¸€æ ·ã€‚

#### NFS çš„ç‰¹ç‚¹

| ç‰¹æ€§ | è¯´æ˜ | ä¼˜åŠ¿ |
|------|------|------|
| **é€æ˜è®¿é—®** | å®¢æˆ·ç«¯æ— éœ€å…³å¿ƒæ–‡ä»¶å®é™…ä½ç½® | ä½¿ç”¨ç®€å•ï¼Œå¦‚åŒæœ¬åœ°æ–‡ä»¶ |
| **é›†ä¸­å­˜å‚¨** | æ•°æ®é›†ä¸­åœ¨ NFS æœåŠ¡å™¨ | ä¾¿äºç®¡ç†ã€å¤‡ä»½ã€å…±äº« |
| **å¤šå®¢æˆ·ç«¯** | å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—® | é€‚åˆé›†ç¾¤ã€å®¹å™¨ç¯å¢ƒ |
| **æƒé™æ§åˆ¶** | æ”¯æŒ UID/GID æ˜ å°„ | çµæ´»çš„è®¿é—®æ§åˆ¶ |

#### NFS ç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | ç‰¹æ€§ | æ¨èåœºæ™¯ |
|------|------|---------|
| **NFSv3** | æ— çŠ¶æ€ã€UDP æ”¯æŒã€æ€§èƒ½è¾ƒå¥½ | ä¼ ç»Ÿ Unix ç¯å¢ƒ |
| **NFSv4** | æœ‰çŠ¶æ€ã€ä»… TCPã€å®‰å…¨æ€§å¼ºã€é˜²ç«å¢™å‹å¥½ | ç°ä»£ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ |
| **NFSv4.1** | å¹¶è¡Œè®¿é—®ã€æ€§èƒ½ä¼˜åŒ– | é«˜æ€§èƒ½éœ€æ±‚ |
| **NFSv4.2** | æœåŠ¡ç«¯å¤åˆ¶ã€ç¨€ç–æ–‡ä»¶ | æœ€æ–°ç‰¹æ€§ |

---

### 1.2 NFS å·¥ä½œåŸç†

#### 1.2.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NFS å®¢æˆ·ç«¯                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åº”ç”¨ç¨‹åºï¼ˆè¯»å†™æ–‡ä»¶ï¼‰                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â†“ VFS (Virtual File System)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NFS Client Module                                     â”‚  â”‚
â”‚  â”‚  - mount.nfs (æŒ‚è½½)                                    â”‚  â”‚
â”‚  â”‚  - rpc.statd (æ–‡ä»¶é”å®š)                                â”‚  â”‚
â”‚  â”‚  - rpcbind (RPC ç«¯å£æ˜ å°„)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“ ç½‘ç»œ (TCP/UDP)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NFS Server Module                                     â”‚  â”‚
â”‚  â”‚  - rpcbind (ç«¯å£ 111)                                  â”‚  â”‚
â”‚  â”‚  - rpc.nfsd (ä¸»è¿›ç¨‹ï¼Œç«¯å£ 2049)                        â”‚  â”‚
â”‚  â”‚  - rpc.mountd (æŒ‚è½½ç®¡ç†ï¼Œç«¯å£ 20048)                   â”‚  â”‚
â”‚  â”‚  - rpc.statd (æ–‡ä»¶é”å®š)                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â†“                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /data/share (å…±äº«ç›®å½•)                                â”‚  â”‚
â”‚  â”‚  - é€šè¿‡ Docker Volume æŒ‚è½½                             â”‚  â”‚
â”‚  â”‚  - å¿…é¡»æ˜¯çœŸå®æ–‡ä»¶ç³»ç»Ÿï¼ˆä¸èƒ½æ˜¯ overlayï¼‰                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         NFS æœåŠ¡å™¨                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.2.2 å…³é”®è¿›ç¨‹è¯´æ˜

| è¿›ç¨‹ | ç«¯å£ | ä½œç”¨ | å¿…éœ€æ€§ |
|------|------|------|--------|
| **rpcbind** | 111 (TCP/UDP) | RPC ç«¯å£æ˜ å°„æœåŠ¡ | âœ… å¿…éœ€ |
| **rpc.nfsd** | 2049 (TCP/UDP) | NFS ä¸»è¿›ç¨‹ï¼Œå¤„ç†æ–‡ä»¶æ“ä½œ | âœ… å¿…éœ€ |
| **rpc.mountd** | 20048 (TCP/UDP) | æŒ‚è½½/å¸è½½ç®¡ç†ï¼Œæƒé™éªŒè¯ | âœ… å¿…éœ€ |
| **rpc.statd** | åŠ¨æ€ç«¯å£ | æ–‡ä»¶é”å®šå’Œå´©æºƒæ¢å¤ | âš ï¸ å¯é€‰ |

---

### 1.3 Docker ç¯å¢ƒä¸­çš„ NFS ç‰¹æ®Šè¦æ±‚

#### 1.3.1 ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨ Docker Volumeï¼Ÿ

| æ–‡ä»¶ç³»ç»Ÿç±»å‹ | æ˜¯å¦æ”¯æŒ NFS å¯¼å‡º | åŸå›  |
|-------------|------------------|------|
| **overlay2**ï¼ˆå®¹å™¨é»˜è®¤ï¼‰ | âŒ ä¸æ”¯æŒ | NFS å†…æ ¸æ¨¡å—æ— æ³•å¯¼å‡º overlay æ–‡ä»¶ç³»ç»Ÿ |
| **ext4/xfs**ï¼ˆVolumeï¼‰ | âœ… æ”¯æŒ | çœŸå®çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ |

**é”™è¯¯ç¤ºä¾‹**ï¼ˆä¼šå¤±è´¥ï¼‰ï¼š
```bash
# âŒ ç›´æ¥åœ¨å®¹å™¨å†…åˆ›å»ºç›®å½•å¹¶å¯¼å‡º
mkdir /data/share
exportfs /data/share
# é”™è¯¯ï¼šdoes not support NFS export
```

**æ­£ç¡®ç¤ºä¾‹**ï¼ˆä½¿ç”¨ Volumeï¼‰ï¼š
```yaml
volumes:
  - nfs-data:/data/share  # âœ… Volume æ˜ å°„åˆ°çœŸå®æ–‡ä»¶ç³»ç»Ÿ
```

#### 1.3.2 ä¸ºä»€ä¹ˆéœ€è¦ privileged æ¨¡å¼ï¼Ÿ

| æƒé™éœ€æ±‚ | è¯´æ˜ |
|---------|------|
| **åŠ è½½å†…æ ¸æ¨¡å—** | nfsd, lockd ç­‰å†…æ ¸æ¨¡å— |
| **ç»‘å®šç‰¹æƒç«¯å£** | ç«¯å£ 111, 2049 (< 1024) |
| **ä¿®æ”¹ç½‘ç»œæ ˆ** | RPC æœåŠ¡æ³¨å†Œ |

---

## ğŸŒ ç¬¬äºŒéƒ¨åˆ†ï¼šç½‘ç»œæ¶æ„ä¸ç¯å¢ƒè¯´æ˜

### 2.1 ç½‘ç»œæ‹“æ‰‘

```
Docker Bridge ç½‘ç»œï¼šnfs-net (10.0.4.0/24)
â”œâ”€â”€ 10.0.4.1   - ç½‘å…³ï¼ˆDocker ç½‘æ¡¥ï¼‰
â”œâ”€â”€ 10.0.4.10  - NFS æœåŠ¡å™¨ï¼ˆnfs-serverï¼‰
â”‚   â”œâ”€â”€ Volume: nfs-data â†’ /data/share
â”‚   â””â”€â”€ ç«¯å£ï¼š111, 2049, 20048
â””â”€â”€ 10.0.4.11  - NFS å®¢æˆ·ç«¯ï¼ˆnfs-clientï¼‰
    â””â”€â”€ æŒ‚è½½ç‚¹ï¼š/mnt/nfs â†’ 10.0.4.10:/data/share
```

### 2.2 Docker Compose é…ç½®è¯´æ˜

```yaml
version: '3.8'

services:
  nfs-server:
    # NFS æœåŠ¡å™¨å®¹å™¨
    container_name: nfs-server
    hostname: nfs-server
    networks:
      nfs-net:
        ipv4_address: 10.0.4.10        # å›ºå®š IP
    privileged: true                    # å¿…éœ€ï¼šåŠ è½½å†…æ ¸æ¨¡å—
    volumes:
      - nfs-data:/data/share            # å¿…éœ€ï¼šVolume æ˜ å°„
    ports:                              # æš´éœ² NFS ç«¯å£
      - "2049/tcp"                      # NFS ä¸»ç«¯å£
      - "111/tcp"                       # RPC ç«¯å£æ˜ å°„
      - "20048/tcp"                     # mountd ç«¯å£

  nfs-client:
    # NFS å®¢æˆ·ç«¯å®¹å™¨
    container_name: nfs-client
    hostname: nfs-client
    networks:
      nfs-net:
        ipv4_address: 10.0.4.11        # å›ºå®š IP
    privileged: true                    # å¿…éœ€ï¼šæŒ‚è½½ NFS
    command: tail -f /dev/null          # ä¿æŒè¿è¡Œ
    depends_on:
      - nfs-server

networks:
  nfs-net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.0.4.0/24
          gateway: 10.0.4.1

volumes:
  nfs-data:                             # å‘½åå·ï¼Œæ˜ å°„åˆ°çœŸå®æ–‡ä»¶ç³»ç»Ÿ
    driver: local
```

---

## ğŸš€ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæœåŠ¡å¯åŠ¨ä¸é…ç½®

### 3.1 å¯åŠ¨ç¯å¢ƒ

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/docker-man/04.nfs/01.manual-nfs

# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker compose ps

# 4. æŸ¥çœ‹ç½‘ç»œé…ç½®
docker network inspect 01manual-nfs_nfs-net

# 5. éªŒè¯ Volume åˆ›å»º
docker volume ls | grep nfs-data
docker volume inspect 01manual-nfs_nfs-data
```

---

### 3.2 NFS æœåŠ¡å™¨é…ç½®

#### 3.2.1 è¿›å…¥æœåŠ¡å™¨å®¹å™¨

```bash
docker compose exec -it nfs-server bash
```

#### 3.2.2 éªŒè¯ Volume æŒ‚è½½

```bash
# 1. æ£€æŸ¥æŒ‚è½½ç‚¹ï¼ˆåº”æ˜¾ç¤º ext4 ç­‰çœŸå®æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œé overlayï¼‰
df -T /data/share

# é¢„æœŸè¾“å‡ºï¼š
# Filesystem     Type  Size  Used Avail Use% Mounted on
# /dev/sda1      ext4   50G  10G   38G  21% /data/share

# 2. éªŒè¯ç›®å½•æƒé™
ls -ld /data/share

# 3. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
echo "NFS Server Share Data" > /data/share/test.txt
ls -l /data/share/
```

#### 3.2.3 é…ç½® NFS å¯¼å‡º

**é…ç½®æ–‡ä»¶ï¼š`/etc/exports`**

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
cat > /etc/exports <<'EOF'
/data/share 10.0.4.0/24(rw,sync,no_subtree_check,sec=sys,wdelay,root_squash,no_all_squash)
EOF

# æŸ¥çœ‹é…ç½®
cat /etc/exports
```

**é…ç½®è¯­æ³•è¯¦è§£**ï¼š

```
/data/share  10.0.4.0/24(rw,sync,no_root_squash,no_all_squash)
    â†‘             â†‘              â†‘
  å…±äº«è·¯å¾„      å®¢æˆ·ç«¯        å¯¼å‡ºé€‰é¡¹ï¼ˆæ— ç©ºæ ¼ï¼ï¼‰
```

#### 3.2.4 å¯¼å‡ºé€‰é¡¹è¯¦è§£

| é€‰é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èåœºæ™¯ |
|------|--------|------|---------|
| **rw** | ro | è¯»å†™æƒé™ | éœ€è¦å†™å…¥æ•°æ® |
| **ro** | - | åªè¯»æƒé™ | ä»…æŸ¥è¯¢æ•°æ® |
| **sync** | âœ… | åŒæ­¥å†™å…¥ç£ç›˜ï¼ˆå®‰å…¨ï¼‰ | ç”Ÿäº§ç¯å¢ƒ |
| **async** | - | å¼‚æ­¥å†™å…¥ï¼ˆå¿«é€Ÿï¼‰ | æµ‹è¯•ç¯å¢ƒ |
| **no_root_squash** | - | å®¢æˆ·ç«¯ root = æœåŠ¡å™¨ root | å¯ä¿¡å®¢æˆ·ç«¯ |
| **root_squash** | âœ… | å®¢æˆ·ç«¯ root â†’ nobody | ä¸å¯ä¿¡å®¢æˆ·ç«¯ |
| **all_squash** | - | æ‰€æœ‰ç”¨æˆ· â†’ nobody | åŒ¿åè®¿é—® |
| **no_all_squash** | âœ… | ä¿ç•™ç”¨æˆ·èº«ä»½ | å¤šç”¨æˆ·ç¯å¢ƒ |
| **no_subtree_check** | - | ä¸æ£€æŸ¥çˆ¶ç›®å½•æƒé™ï¼ˆå¿«ï¼‰ | æ¨è |
| **subtree_check** | âœ… | æ£€æŸ¥çˆ¶ç›®å½•æƒé™ï¼ˆæ…¢ï¼‰ | å…±äº«å­ç›®å½• |

**ç»„åˆç¤ºä¾‹**ï¼š

```bash
# åœºæ™¯ 1ï¼šå¼€å‘æµ‹è¯•ï¼ˆå…¨æƒé™ï¼‰
/data/share 10.0.4.0/24(rw,sync,no_root_squash,no_all_squash)

# åœºæ™¯ 2ï¼šç”Ÿäº§ç¯å¢ƒï¼ˆé™åˆ¶ rootï¼‰
/data/share 10.0.4.0/24(rw,sync,root_squash,no_all_squash)

# åœºæ™¯ 3ï¼šåªè¯»å…±äº«ï¼ˆå…¬å…±æ•°æ®ï¼‰
/data/share 10.0.4.0/24(ro,sync,root_squash)

# åœºæ™¯ 4ï¼šåŒ¿åè®¿é—®ï¼ˆæ‰€æœ‰ç”¨æˆ·æ˜ å°„ä¸º nobodyï¼‰
/data/share *(rw,sync,all_squash,anonuid=65534,anongid=65534)

# åœºæ™¯ 5ï¼šå¤šä¸ªå®¢æˆ·ç«¯ä¸åŒæƒé™
/data/share 10.0.4.11(rw,sync) 10.0.4.12(ro,sync)
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- **é€‰é¡¹ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼**ï¼š`(rw,sync)` âœ… | `(rw, sync)` âŒ
- **è·¯å¾„ä¸å®¢æˆ·ç«¯ä¹‹é—´æœ‰ç©ºæ ¼**ï¼š`/path 10.0.4.0/24(rw)` âœ…
- **å®¢æˆ·ç«¯ä¸é€‰é¡¹ä¹‹é—´æ— ç©ºæ ¼**ï¼š`10.0.4.0/24(rw)` âœ…

#### 3.2.5 å¯¼å‡ºå…±äº«å¹¶éªŒè¯

```bash
# 1. é‡æ–°å¯¼å‡ºæ‰€æœ‰å…±äº«ï¼ˆ-a: all, -r: re-export, -v: verboseï¼‰
exportfs -arv

# é¢„æœŸè¾“å‡ºï¼š
# exporting 10.0.4.0/24:/data/share

# 2. æŸ¥çœ‹å·²å¯¼å‡ºçš„å…±äº«ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
exportfs -v

# é¢„æœŸè¾“å‡ºï¼š
# /data/share  10.0.4.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,
#              secure,no_root_squash,no_all_squash)

# 3. æŸ¥çœ‹æœ¬åœ°å¯æŒ‚è½½çš„å…±äº«
showmount -e localhost

# é¢„æœŸè¾“å‡ºï¼š
# Export list for localhost:
# /data/share 10.0.4.0/24

# 4. æ£€æŸ¥ RPC æœåŠ¡
rpcinfo -p

# é¢„æœŸè¾“å‡ºåº”åŒ…å«ï¼š
# program vers proto   port  service
#  100000    4   tcp    111  portmapper
#  100003    3   tcp   2049  nfs
#  100005    3   tcp  20048  mountd

# 5. æ£€æŸ¥ NFS è¿›ç¨‹
ps aux | grep -E 'rpc|nfs'

# é¢„æœŸè¾“å‡ºåº”åŒ…å«ï¼š
# rpcbind
# rpc.nfsd
# rpc.mountd
```

---

## ğŸ’» ç¬¬å››éƒ¨åˆ†ï¼šNFS å®¢æˆ·ç«¯é…ç½®

### 4.1 è¿›å…¥å®¢æˆ·ç«¯å®¹å™¨

```bash
docker compose exec -it nfs-client bash
```

### 4.2 å¯åŠ¨å®¢æˆ·ç«¯ RPC æœåŠ¡

```bash
# 1. å¯åŠ¨ RPC ç«¯å£æ˜ å°„æœåŠ¡
rpcbind

# 2. å¯åŠ¨æ–‡ä»¶é”å®šæœåŠ¡ï¼ˆå¯é€‰ï¼Œç”¨äºæ–‡ä»¶é”å®šï¼‰
rpc.statd

# 3. éªŒè¯æœåŠ¡å¯åŠ¨
ps aux | grep rpc
```

### 4.3 æŸ¥çœ‹æœåŠ¡å™¨å…±äº«åˆ—è¡¨

```bash
# æŸ¥çœ‹ NFS æœåŠ¡å™¨çš„å¯¼å‡ºåˆ—è¡¨
showmount -e 10.0.4.10

# é¢„æœŸè¾“å‡ºï¼š
# Export list for 10.0.4.10:
# /data/share 10.0.4.0/24

# å¦‚æœå¤±è´¥ï¼Œæ’æŸ¥æ­¥éª¤ï¼š
# 1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 10.0.4.10

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦å¯è¾¾
telnet 10.0.4.10 2049
telnet 10.0.4.10 111

# 3. æ£€æŸ¥æœåŠ¡å™¨ç«¯ RPC æœåŠ¡
rpcinfo -p 10.0.4.10
```

### 4.4 æŒ‚è½½ NFS å…±äº«

#### 4.4.1 åˆ›å»ºæŒ‚è½½ç‚¹

```bash
mkdir -p /mnt/nfs
```

#### 4.4.2 æŒ‚è½½å‘½ä»¤

```bash
# åŸºç¡€æŒ‚è½½ï¼ˆä½¿ç”¨é»˜è®¤é€‰é¡¹ï¼‰
mount -t nfs 10.0.4.10:/data/share /mnt/nfs

# å¸¦é€‰é¡¹æŒ‚è½½ï¼ˆæ¨èï¼‰
mount -t nfs -o rw,sync,hard,intr 10.0.4.10:/data/share /mnt/nfs

# æŒ‡å®š NFS ç‰ˆæœ¬ï¼ˆNFSv4ï¼‰
mount -t nfs -o vers=4 10.0.4.10:/data/share /mnt/nfs

# é«˜æ€§èƒ½æŒ‚è½½ï¼ˆå¼‚æ­¥ã€å¤§ç¼“å†²åŒºï¼‰
mount -t nfs -o async,rsize=1048576,wsize=1048576 10.0.4.10:/data/share /mnt/nfs
```

#### 4.4.3 æŒ‚è½½é€‰é¡¹è¯¦è§£

| é€‰é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èåœºæ™¯ |
|------|--------|------|---------|
| **rw** | âœ… | è¯»å†™æŒ‚è½½ | æ•°æ®å†™å…¥ |
| **ro** | - | åªè¯»æŒ‚è½½ | åªè¯»æ•°æ® |
| **sync** | - | åŒæ­¥å†™å…¥ï¼ˆå®‰å…¨ï¼‰ | é‡è¦æ•°æ® |
| **async** | âœ… | å¼‚æ­¥å†™å…¥ï¼ˆå¿«é€Ÿï¼‰ | æ€§èƒ½ä¼˜å…ˆ |
| **hard** | âœ… | æŒ‚è½½å¤±è´¥æ—¶æŒç»­é‡è¯• | ç”Ÿäº§ç¯å¢ƒ |
| **soft** | - | æŒ‚è½½å¤±è´¥æ—¶è¿”å›é”™è¯¯ | ä¸´æ—¶æŒ‚è½½ |
| **intr** | - | å…è®¸ä¸­æ–­æŒ‚è½½æ“ä½œ | é…åˆ hard |
| **timeo=600** | 600 | è¶…æ—¶æ—¶é—´ï¼ˆ0.1 ç§’å•ä½ï¼‰ | ç½‘ç»œæ…¢æ—¶å¢å¤§ |
| **retrans=2** | 2 | é‡ä¼ æ¬¡æ•° | ç½‘ç»œä¸ç¨³å®šæ—¶å¢å¤§ |
| **rsize=N** | åå•† | è¯»ç¼“å†²åŒºå¤§å°ï¼ˆå­—èŠ‚ï¼‰ | æ€§èƒ½ä¼˜åŒ– |
| **wsize=N** | åå•† | å†™ç¼“å†²åŒºå¤§å°ï¼ˆå­—èŠ‚ï¼‰ | æ€§èƒ½ä¼˜åŒ– |
| **vers=4** | 4.2 | æŒ‡å®š NFS ç‰ˆæœ¬ | å…¼å®¹æ€§ |
| **nolock** | - | ç¦ç”¨æ–‡ä»¶é”å®š | ä¸éœ€è¦é” |
| **_netdev** | - | ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿæ ‡è®° | /etc/fstab å¿…éœ€ |

**æ¨èç»„åˆ**ï¼š

```bash
# ç”Ÿäº§ç¯å¢ƒï¼ˆå¯é æ€§ä¼˜å…ˆï¼‰
mount -t nfs -o rw,sync,hard,intr,timeo=600,retrans=3 10.0.4.10:/data/share /mnt/nfs

# å¼€å‘ç¯å¢ƒï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
mount -t nfs -o rw,async,rsize=1048576,wsize=1048576 10.0.4.10:/data/share /mnt/nfs

# å®¹å™¨ç¯å¢ƒï¼ˆæ¨èï¼‰
mount -t nfs -o vers=4,rw,hard,intr,nolock 10.0.4.10:/data/share /mnt/nfs
```

### 4.5 éªŒè¯æŒ‚è½½

```bash
# 1. æŸ¥çœ‹æŒ‚è½½çŠ¶æ€
mount | grep nfs

# é¢„æœŸè¾“å‡ºï¼š
# 10.0.4.10:/data/share on /mnt/nfs type nfs4
# (rw,relatime,vers=4.2,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,...)

# 2. æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
df -h | grep nfs

# é¢„æœŸè¾“å‡ºï¼š
# 10.0.4.10:/data/share   50G  10G  38G  21% /mnt/nfs

# 3. æŸ¥çœ‹æŒ‚è½½è¯¦ç»†ä¿¡æ¯
df -T /mnt/nfs

# 4. åˆ—å‡ºè¿œç¨‹ç›®å½•å†…å®¹
ls -l /mnt/nfs

# é¢„æœŸè¾“å‡ºï¼š
# -rw-r--r-- 1 root root 22 Oct 18 10:00 test.txt
```

### 4.6 æµ‹è¯•è¯»å†™

```bash
# 1. è¯»å–æœåŠ¡å™¨åˆ›å»ºçš„æ–‡ä»¶
cat /mnt/nfs/test.txt

# é¢„æœŸè¾“å‡ºï¼š
# NFS Server Share Data

# 2. æµ‹è¯•å†™å…¥ï¼ˆåˆ›å»ºæ–°æ–‡ä»¶ï¼‰
echo "Client Write Test" > /mnt/nfs/client-test.txt

# 3. éªŒè¯æ–‡ä»¶åˆ›å»ºæˆåŠŸ
ls -l /mnt/nfs/

# 4. è¿”å›æœåŠ¡å™¨ç«¯éªŒè¯ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰
docker compose exec nfs-server ls -l /data/share

# é¢„æœŸè¾“å‡ºåº”åŒ…å« client-test.txt
```

---

## ğŸ”‘ ç¬¬äº”éƒ¨åˆ†ï¼šæƒé™æ§åˆ¶è¯¦è§£

### 5.1 ç”¨æˆ·èº«ä»½æ˜ å°„æœºåˆ¶

#### 5.1.1 æ˜ å°„è§„åˆ™è¡¨

| å¯¼å‡ºé€‰é¡¹ | å®¢æˆ·ç«¯ root | å®¢æˆ·ç«¯æ™®é€šç”¨æˆ· | è¯´æ˜ |
|---------|-----------|--------------|------|
| **é»˜è®¤** | â†’ nobody (65534) | ä¿æŒåŸ UID/GID | å®‰å…¨æ¨¡å¼ |
| **no_root_squash** | ä¿æŒ root (0) | ä¿æŒåŸ UID/GID | å¯ä¿¡å®¢æˆ·ç«¯ |
| **all_squash** | â†’ nobody (65534) | â†’ nobody (65534) | åŒ¿åæ¨¡å¼ |
| **all_squash + anonuid** | â†’ æŒ‡å®š UID | â†’ æŒ‡å®š UID | ç»Ÿä¸€ç”¨æˆ· |

#### 5.1.2 æµ‹è¯•ç”¨æˆ·æ˜ å°„

**åœºæ™¯ 1ï¼šé»˜è®¤é…ç½®ï¼ˆroot_squashï¼‰**

```bash
# æœåŠ¡å™¨é…ç½®
/data/share 10.0.4.0/24(rw,sync)  # é»˜è®¤åŒ…å« root_squash

# å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆroot ç”¨æˆ·ï¼‰
docker compose exec nfs-client bash
echo "root file" > /mnt/nfs/root-test.txt
ls -l /mnt/nfs/root-test.txt

# è¾“å‡ºï¼š
# -rw-r--r-- 1 nobody nogroup 10 Oct 18 10:00 root-test.txt
#               â†‘ root è¢«æ˜ å°„ä¸º nobody

# å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
useradd testuser
su - testuser
echo "user file" > /mnt/nfs/user-test.txt
exit

ls -l /mnt/nfs/user-test.txt
# è¾“å‡ºï¼š
# -rw-r--r-- 1 testuser testuser 10 Oct 18 10:01 user-test.txt
#               â†‘ æ™®é€šç”¨æˆ·ä¿æŒåŸèº«ä»½
```

**åœºæ™¯ 2ï¼šno_root_squashï¼ˆå…è®¸ rootï¼‰**

```bash
# æœåŠ¡å™¨é…ç½®
/data/share 10.0.4.0/24(rw,sync,no_root_squash)

exportfs -arv

# å®¢æˆ·ç«¯æµ‹è¯•
echo "root file 2" > /mnt/nfs/root-test2.txt
ls -l /mnt/nfs/root-test2.txt

# è¾“å‡ºï¼š
# -rw-r--r-- 1 root root 12 Oct 18 10:02 root-test2.txt
#               â†‘ root èº«ä»½ä¿ç•™
```

**åœºæ™¯ 3ï¼šall_squashï¼ˆæ‰€æœ‰ç”¨æˆ·åŒ¿åï¼‰**

```bash
# æœåŠ¡å™¨é…ç½®
/data/share 10.0.4.0/24(rw,sync,all_squash)

exportfs -arv

# å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆrootï¼‰
echo "test 1" > /mnt/nfs/all-squash-root.txt

# å®¢æˆ·ç«¯æµ‹è¯•ï¼ˆæ™®é€šç”¨æˆ·ï¼‰
su - testuser
echo "test 2" > /mnt/nfs/all-squash-user.txt
exit

# æŸ¥çœ‹æ–‡ä»¶
ls -l /mnt/nfs/all-squash-*.txt

# è¾“å‡ºï¼ˆæ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯ nobodyï¼‰ï¼š
# -rw-r--r-- 1 nobody nogroup 7 Oct 18 10:03 all-squash-root.txt
# -rw-r--r-- 1 nobody nogroup 7 Oct 18 10:03 all-squash-user.txt
```

**åœºæ™¯ 4ï¼šç»Ÿä¸€ç”¨æˆ·æ˜ å°„ï¼ˆWeb æœåŠ¡å™¨åœºæ™¯ï¼‰**

```bash
# æœåŠ¡å™¨é…ç½®ï¼ˆæ˜ å°„åˆ° www-data, UID=33ï¼‰
/data/share 10.0.4.0/24(rw,sync,all_squash,anonuid=33,anongid=33)

exportfs -arv

# å®¢æˆ·ç«¯æµ‹è¯•
echo "www file" > /mnt/nfs/www-test.txt
ls -l /mnt/nfs/www-test.txt

# è¾“å‡ºï¼ˆæ‰€æœ‰æ–‡ä»¶å±äº www-dataï¼‰ï¼š
# -rw-r--r-- 1 www-data www-data 9 Oct 18 10:04 www-test.txt
```

### 5.2 æ–‡ä»¶ç³»ç»Ÿæƒé™ä¸ NFS æƒé™çš„å…³ç³»

**é‡è¦æ¦‚å¿µ**ï¼š
- **NFS å¯¼å‡ºé€‰é¡¹**ï¼šæ§åˆ¶å®¢æˆ·ç«¯æ˜¯å¦æœ‰ `rw` æƒé™
- **æ–‡ä»¶ç³»ç»Ÿæƒé™**ï¼šæ§åˆ¶ç”¨æˆ·æ˜¯å¦èƒ½å®é™…å†™å…¥æ–‡ä»¶

**é—®é¢˜ç¤ºä¾‹**ï¼š

```bash
# æœåŠ¡å™¨é…ç½®ï¼ˆå…è®¸è¯»å†™ï¼‰
/data/share 10.0.4.0/24(rw,sync,no_root_squash)

# ä½†å…±äº«ç›®å½•æƒé™ä¸è¶³
ls -ld /data/share
# drwxr-xr-x 2 root root 4096 Oct 18 10:00 /data/share
#         â†‘ å…¶ä»–ç”¨æˆ·æ— å†™æƒé™

# å®¢æˆ·ç«¯æŒ‚è½½åå°è¯•å†™å…¥
echo "test" > /mnt/nfs/test.txt
# é”™è¯¯ï¼šPermission denied
```

**è§£å†³æ–¹æ³•**ï¼š

```bash
# æ–¹æ³• 1ï¼šä¿®æ”¹ç›®å½•æƒé™ï¼ˆæ¨èï¼‰
chmod 777 /data/share  # æˆ– chmod o+w /data/share

# æ–¹æ³• 2ï¼šä¿®æ”¹ç›®å½•æ‰€æœ‰è€…
chown www-data:www-data /data/share

# æ–¹æ³• 3ï¼šä½¿ç”¨ ACL
setfacl -m u:www-data:rwx /data/share
```

---

## ğŸ“Š ç¬¬å…­éƒ¨åˆ†ï¼šæ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–

### 6.1 æ€§èƒ½æµ‹è¯•

#### 6.1.1 å†™å…¥æ€§èƒ½æµ‹è¯•

```bash
# åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ

# æµ‹è¯• 1ï¼šå†™å…¥ 1GB æ•°æ®ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰
time dd if=/dev/zero of=/mnt/nfs/testfile bs=1M count=1024

# æµ‹è¯• 2ï¼šå†™å…¥ 1GB æ•°æ®ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰
# å…ˆé‡æ–°æŒ‚è½½ä¸º async
umount /mnt/nfs
mount -t nfs -o async 10.0.4.10:/data/share /mnt/nfs
time dd if=/dev/zero of=/mnt/nfs/testfile bs=1M count=1024

# æµ‹è¯• 3ï¼šå°æ–‡ä»¶å†™å…¥ï¼ˆåˆ›å»º 1000 ä¸ªå°æ–‡ä»¶ï¼‰
time for i in {1..1000}; do echo "test $i" > /mnt/nfs/file_$i.txt; done
```

#### 6.1.2 è¯»å–æ€§èƒ½æµ‹è¯•

```bash
# æµ‹è¯• 1ï¼šè¯»å– 1GB æ•°æ®
time dd if=/mnt/nfs/testfile of=/dev/null bs=1M

# æµ‹è¯• 2ï¼šè¯»å–å°æ–‡ä»¶
time cat /mnt/nfs/file_*.txt > /dev/null

# æµ‹è¯• 3ï¼šç¼“å­˜æ•ˆæœï¼ˆç¬¬äºŒæ¬¡è¯»å–åº”è¯¥æ›´å¿«ï¼‰
time dd if=/mnt/nfs/testfile of=/dev/null bs=1M
```

#### 6.1.3 æ¸…ç†æµ‹è¯•æ–‡ä»¶

```bash
rm -f /mnt/nfs/testfile
rm -f /mnt/nfs/file_*.txt
```

### 6.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–é¡¹ | é…ç½® | æ€§èƒ½æå‡ | é£é™© |
|-------|------|---------|------|
| **å¼‚æ­¥å†™å…¥** | `async` | å†™å…¥é€Ÿåº¦æå‡ 50-300% | æ–­ç”µå¯èƒ½ä¸¢æ•°æ® |
| **å¢å¤§ç¼“å†²åŒº** | `rsize=1048576,wsize=1048576` | å¤§æ–‡ä»¶ä¼ è¾“æå‡ 20-50% | å†…å­˜å ç”¨å¢åŠ  |
| **ç¦ç”¨æ–‡ä»¶é”** | `nolock` | å¹¶å‘æ€§èƒ½æå‡ 10-20% | æ— æ–‡ä»¶é”ä¿æŠ¤ |
| **NFSv4.1** | `vers=4.1` | å¹¶è¡Œè®¿é—®æ€§èƒ½æå‡ | å…¼å®¹æ€§è¦æ±‚ |
| **ç½‘ç»œä¼˜åŒ–** | ä½¿ç”¨ä¸‡å…†ç½‘å¡ã€Jumbo Frame | ä¼ è¾“é€Ÿåº¦æå‡ | ç¡¬ä»¶æˆæœ¬ |

**æ¨èé…ç½®**ï¼š

```bash
# ç”Ÿäº§ç¯å¢ƒï¼ˆå¹³è¡¡æ€§èƒ½ä¸å®‰å…¨ï¼‰
mount -t nfs -o vers=4,rw,hard,intr,rsize=262144,wsize=262144 \
  10.0.4.10:/data/share /mnt/nfs

# é«˜æ€§èƒ½åœºæ™¯ï¼ˆæ¥å—æ•°æ®ä¸¢å¤±é£é™©ï¼‰
mount -t nfs -o vers=4,rw,async,nolock,rsize=1048576,wsize=1048576 \
  10.0.4.10:/data/share /mnt/nfs
```

---

## ğŸ”§ ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ•…éšœæ’é™¤

### 7.1 å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ³•

#### é”™è¯¯ 1ï¼šdoes not support NFS export

```bash
# é”™è¯¯ä¿¡æ¯
exportfs: /data/share does not support NFS export

# åŸå› 
df -T /data/share
# Filesystem     Type     Size  Used Avail Use% Mounted on
# overlay        overlay   50G   10G   38G  21% /data/share
#   â†‘ overlay æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒ NFS å¯¼å‡º

# è§£å†³
# å¿…é¡»ä½¿ç”¨ Docker Volumeï¼Œä¿®æ”¹ compose.ymlï¼š
volumes:
  - nfs-data:/data/share  # ä½¿ç”¨å‘½åå·
```

#### é”™è¯¯ 2ï¼šaccess denied by server

```bash
# é”™è¯¯ä¿¡æ¯
mount.nfs: access denied by server while mounting 10.0.4.10:/data/share

# åŸå›  1ï¼šå®¢æˆ·ç«¯ IP ä¸åœ¨å…è®¸èŒƒå›´å†…
# æ£€æŸ¥æœåŠ¡å™¨ /etc/exports
cat /etc/exports
# /data/share 10.0.4.11(rw)  # åªå…è®¸ 10.0.4.11ï¼Œä¸å…è®¸å…¶ä»– IP

# è§£å†³ï¼šä¿®æ”¹ä¸ºç½‘æ®µ
/data/share 10.0.4.0/24(rw)
exportfs -arv

# åŸå›  2ï¼šexportfs æœªæ›´æ–°
exportfs -arv  # é‡æ–°å¯¼å‡º
```

#### é”™è¯¯ 3ï¼šmount.nfs: Connection timed out

```bash
# é”™è¯¯ä¿¡æ¯
mount.nfs: Connection timed out

# æ’æŸ¥æ­¥éª¤ï¼š

# 1. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 10.0.4.10

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
telnet 10.0.4.10 2049  # NFS ç«¯å£
telnet 10.0.4.10 111   # RPC ç«¯å£

# 3. æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™
docker compose exec nfs-server iptables -L

# 4. æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
docker compose exec nfs-server ps aux | grep rpc
docker compose exec nfs-server rpcinfo -p

# 5. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
docker compose logs nfs-server
```

#### é”™è¯¯ 4ï¼šPermission deniedï¼ˆæƒé™æ‹’ç»ï¼‰

```bash
# é”™è¯¯ä¿¡æ¯
echo "test" > /mnt/nfs/test.txt
-bash: /mnt/nfs/test.txt: Permission denied

# åŸå›  1ï¼šNFS åªè¯»æŒ‚è½½
mount | grep nfs
# 10.0.4.10:/data/share on /mnt/nfs type nfs4 (ro,...)
#                                                  â†‘ åªè¯»

# è§£å†³ï¼šé‡æ–°æŒ‚è½½ä¸º rw
umount /mnt/nfs
mount -t nfs -o rw 10.0.4.10:/data/share /mnt/nfs

# åŸå›  2ï¼šæ–‡ä»¶ç³»ç»Ÿæƒé™ä¸è¶³
ls -ld /data/share  # åœ¨æœåŠ¡å™¨ä¸Šæ£€æŸ¥
# drwxr-xr-x 2 root root ...
#         â†‘ å…¶ä»–ç”¨æˆ·æ— å†™æƒé™

# è§£å†³ï¼šä¿®æ”¹æƒé™
chmod 777 /data/share  # æˆ– chmod o+w /data/share

# åŸå›  3ï¼šç”¨æˆ·è¢«æ˜ å°„ä¸º nobodyï¼Œä½† nobody æ— æƒé™
# è§£å†³ï¼šä½¿ç”¨ no_root_squash æˆ–ä¿®æ”¹ç›®å½•æ‰€æœ‰è€…
chown nobody:nogroup /data/share
```

#### é”™è¯¯ 5ï¼šStale file handle

```bash
# é”™è¯¯ä¿¡æ¯
ls /mnt/nfs
ls: cannot access '/mnt/nfs': Stale file handle

# åŸå› ï¼šNFS æœåŠ¡å™¨é‡å¯æˆ–å…±äº«ç›®å½•è¢«åˆ é™¤

# è§£å†³ï¼š
# 1. å¸è½½
umount -f /mnt/nfs  # å¼ºåˆ¶å¸è½½
# æˆ–
umount -l /mnt/nfs  # æ‡’å¸è½½

# 2. é‡æ–°æŒ‚è½½
mount -t nfs 10.0.4.10:/data/share /mnt/nfs
```

### 7.2 è°ƒè¯•å‘½ä»¤

```bash
# æœåŠ¡å™¨ç«¯è°ƒè¯•

# 1. æ£€æŸ¥å¯¼å‡ºé…ç½®
cat /etc/exports
exportfs -v

# 2. æŸ¥çœ‹å·²è¿æ¥çš„å®¢æˆ·ç«¯
showmount -a

# 3. æ£€æŸ¥ RPC æœåŠ¡
rpcinfo -p
rpcinfo -p | grep -E 'nfs|mount'

# 4. æŸ¥çœ‹ NFS ç»Ÿè®¡ä¿¡æ¯
nfsstat -s  # æœåŠ¡å™¨ç»Ÿè®¡
nfsstat -m  # æŒ‚è½½ç‚¹ç»Ÿè®¡

# 5. æ£€æŸ¥è¿›ç¨‹
ps aux | grep -E 'rpc|nfs'

# 6. æŸ¥çœ‹æ—¥å¿—
dmesg | tail -20
journalctl -u nfs-server -n 50

# å®¢æˆ·ç«¯è°ƒè¯•

# 1. æŸ¥çœ‹æŒ‚è½½è¯¦æƒ…
mount | grep nfs
df -h /mnt/nfs

# 2. æ£€æŸ¥æœåŠ¡å™¨å…±äº«
showmount -e 10.0.4.10

# 3. æ£€æŸ¥ RPC è¿æ¥
rpcinfo -p 10.0.4.10

# 4. è°ƒè¯•æŒ‚è½½ï¼ˆæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼‰
mount -vvv -t nfs 10.0.4.10:/data/share /mnt/nfs

# 5. æŸ¥çœ‹å†…æ ¸æ—¥å¿—
dmesg | grep -i nfs | tail -20

# 6. ç½‘ç»œæŠ“åŒ…
tcpdump -i eth0 host 10.0.4.10 and port 2049 -nn
```

---

## ğŸ’¾ ç¬¬å…«éƒ¨åˆ†ï¼šæŒä¹…åŒ–æŒ‚è½½ï¼ˆ/etc/fstabï¼‰

### 8.1 fstab é…ç½®

```bash
# ç¼–è¾‘ /etc/fstab
vim /etc/fstab

# æ·»åŠ ä»¥ä¸‹è¡Œ
10.0.4.10:/data/share  /mnt/nfs  nfs  defaults,_netdev  0  0
```

### 8.2 fstab é€‰é¡¹è¯¦è§£

```
10.0.4.10:/data/share  /mnt/nfs  nfs  defaults,_netdev,vers=4,rw,hard  0  0
      â†‘                   â†‘        â†‘              â†‘                    â†‘  â†‘
   è¿œç¨‹è·¯å¾„            æŒ‚è½½ç‚¹  æ–‡ä»¶ç³»ç»Ÿç±»å‹      æŒ‚è½½é€‰é¡¹              è½¬å‚¨ æ£€æŸ¥
```

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **è®¾å¤‡** | NFS æœåŠ¡å™¨:å…±äº«è·¯å¾„ | `10.0.4.10:/data/share` |
| **æŒ‚è½½ç‚¹** | æœ¬åœ°ç›®å½• | `/mnt/nfs` |
| **æ–‡ä»¶ç³»ç»Ÿ** | å›ºå®šä¸º `nfs` | `nfs` |
| **é€‰é¡¹** | æŒ‚è½½é€‰é¡¹ï¼ˆé€—å·åˆ†éš”ï¼‰ | `defaults,_netdev` |
| **è½¬å‚¨** | æ˜¯å¦å¤‡ä»½ï¼ˆ0=å¦ï¼‰ | `0` |
| **æ£€æŸ¥** | å¯åŠ¨æ—¶æ£€æŸ¥é¡ºåºï¼ˆ0=ä¸æ£€æŸ¥ï¼‰ | `0` |

### 8.3 é‡è¦é€‰é¡¹

| é€‰é¡¹ | è¯´æ˜ | å¿…éœ€æ€§ |
|------|------|--------|
| **_netdev** | ç­‰å¾…ç½‘ç»œå°±ç»ªåå†æŒ‚è½½ | âœ… **å¿…éœ€** |
| **defaults** | rw,suid,dev,exec,auto,nouser,async | æ¨è |
| **auto** | å¯åŠ¨æ—¶è‡ªåŠ¨æŒ‚è½½ | æ¨è |
| **noauto** | ä¸è‡ªåŠ¨æŒ‚è½½ï¼ˆæ‰‹åŠ¨ mount -aï¼‰ | æŒ‰éœ€ |
| **x-systemd.automount** | å»¶è¿ŸæŒ‚è½½ï¼ˆè®¿é—®æ—¶æ‰æŒ‚è½½ï¼‰ | å¯é€‰ |

### 8.4 æµ‹è¯• fstab

```bash
# 1. æµ‹è¯•æŒ‚è½½ï¼ˆä¸å®é™…æŒ‚è½½ï¼‰
mount -fav

# 2. å¸è½½å½“å‰æŒ‚è½½
umount /mnt/nfs

# 3. æ ¹æ® fstab æŒ‚è½½
mount -a

# 4. éªŒè¯
df -h /mnt/nfs
mount | grep nfs
```

### 8.5 é«˜çº§ fstab é…ç½®

```bash
# ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆå¯é æ€§ä¼˜å…ˆï¼‰
10.0.4.10:/data/share  /mnt/nfs  nfs  _netdev,vers=4,rw,hard,intr,timeo=600,retrans=3  0  0

# å¼€å‘ç¯å¢ƒé…ç½®ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
10.0.4.10:/data/share  /mnt/nfs  nfs  _netdev,vers=4,rw,async,rsize=1048576,wsize=1048576  0  0

# å»¶è¿ŸæŒ‚è½½é…ç½®ï¼ˆæŒ‰éœ€æŒ‚è½½ï¼‰
10.0.4.10:/data/share  /mnt/nfs  nfs  _netdev,x-systemd.automount,x-systemd.idle-timeout=60  0  0
```

---

## ğŸ“‹ ç¬¬ä¹éƒ¨åˆ†ï¼šæµ‹è¯•æ£€æŸ¥æ¸…å•

### 9.1 åŸºç¡€çŸ¥è¯†

- [ ] ç†è§£ NFS çš„å·¥ä½œåŸç†å’Œæ¶æ„
- [ ] ç†è§£ Docker ç¯å¢ƒä¸­å¿…é¡»ä½¿ç”¨ Volume çš„åŸå› 
- [ ] æŒæ¡ NFS ä¸»è¦è¿›ç¨‹ï¼ˆrpcbind, nfsd, mountdï¼‰çš„ä½œç”¨
- [ ] ç†è§£ NFSv3 å’Œ NFSv4 çš„åŒºåˆ«

### 9.2 æœåŠ¡å™¨é…ç½®

- [ ] æ­£ç¡®é…ç½® `/etc/exports` æ–‡ä»¶
- [ ] ç†è§£å¯¼å‡ºé€‰é¡¹ï¼ˆrw/ro, sync/async, root_squash ç­‰ï¼‰
- [ ] ä½¿ç”¨ `exportfs -arv` å¯¼å‡ºå…±äº«
- [ ] ä½¿ç”¨ `showmount -e` æŸ¥çœ‹å¯¼å‡ºåˆ—è¡¨
- [ ] éªŒè¯ RPC æœåŠ¡æ­£å¸¸è¿è¡Œ

### 9.3 å®¢æˆ·ç«¯æŒ‚è½½

- [ ] ä½¿ç”¨ `showmount -e` æŸ¥è¯¢æœåŠ¡å™¨å…±äº«
- [ ] ä½¿ç”¨ `mount -t nfs` æŒ‚è½½å…±äº«
- [ ] ç†è§£æŒ‚è½½é€‰é¡¹ï¼ˆhard/soft, sync/async, rsize/wsize ç­‰ï¼‰
- [ ] éªŒè¯æŒ‚è½½æˆåŠŸï¼ˆ`df -h`, `mount` å‘½ä»¤ï¼‰
- [ ] æµ‹è¯•è¯»å†™æ“ä½œ

### 9.4 æƒé™æ§åˆ¶

- [ ] ç†è§£ç”¨æˆ·èº«ä»½æ˜ å°„æœºåˆ¶ï¼ˆroot_squash, all_squashï¼‰
- [ ] æµ‹è¯• root ç”¨æˆ·æ˜ å°„ä¸º nobody
- [ ] æµ‹è¯•æ™®é€šç”¨æˆ·ä¿æŒåŸèº«ä»½
- [ ] ç†è§£ NFS æƒé™ä¸æ–‡ä»¶ç³»ç»Ÿæƒé™çš„å…³ç³»
- [ ] é…ç½®ç»Ÿä¸€ç”¨æˆ·æ˜ å°„ï¼ˆanonuid/anongidï¼‰

### 9.5 æ•…éšœæ’é™¤

- [ ] èƒ½å¤Ÿè¯Šæ–­ "does not support NFS export" é”™è¯¯
- [ ] èƒ½å¤Ÿè¯Šæ–­ "access denied" é”™è¯¯
- [ ] èƒ½å¤Ÿè¯Šæ–­ "Connection timed out" é”™è¯¯
- [ ] èƒ½å¤Ÿè¯Šæ–­ "Permission denied" é”™è¯¯
- [ ] ä½¿ç”¨ `rpcinfo`, `nfsstat` ç­‰å·¥å…·è°ƒè¯•

### 9.6 é«˜çº§åŠŸèƒ½

- [ ] é…ç½® `/etc/fstab` å®ç°æŒä¹…åŒ–æŒ‚è½½
- [ ] è¿›è¡Œæ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] é…ç½®å¤šå®¢æˆ·ç«¯ä¸åŒæƒé™
- [ ] ç†è§£æ€§èƒ½ä¼˜åŒ–é€‰é¡¹ï¼ˆasync, rsize/wsizeï¼‰

---

## â“ ç¬¬åéƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå®¹å™¨ä¸­å¿…é¡»ä½¿ç”¨ Volumeï¼Ÿ

**ç­”**ï¼šDocker å®¹å™¨é»˜è®¤ä½¿ç”¨ overlay2 æ–‡ä»¶ç³»ç»Ÿï¼Œ**NFS å†…æ ¸æ¨¡å—æ— æ³•å¯¼å‡º overlay æ–‡ä»¶ç³»ç»Ÿ**ã€‚å¿…é¡»ä½¿ç”¨ Docker Volume æ˜ å°„åˆ°çœŸå®çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext4, xfsï¼‰æ‰èƒ½å¯¼å‡ºã€‚

éªŒè¯æ–¹æ³•ï¼š
```bash
df -T /data/share
# overlay    â†’ âŒ æ— æ³•å¯¼å‡º
# ext4       â†’ âœ… å¯ä»¥å¯¼å‡º
```

---

### Q2: root_squash å’Œ all_squash çš„åŒºåˆ«ï¼Ÿ

**ç­”**ï¼š

| é€‰é¡¹ | root ç”¨æˆ· | æ™®é€šç”¨æˆ· | ä½¿ç”¨åœºæ™¯ |
|------|----------|---------|---------|
| **root_squash**ï¼ˆé»˜è®¤ï¼‰ | â†’ nobody | ä¿æŒåŸèº«ä»½ | æ ‡å‡†å®‰å…¨æ¨¡å¼ |
| **no_root_squash** | ä¿æŒ root | ä¿æŒåŸèº«ä»½ | å¯ä¿¡å®¢æˆ·ç«¯ |
| **all_squash** | â†’ nobody | â†’ nobody | åŒ¿åè®¿é—® |

---

### Q3: å¦‚ä½•å®ç°å¤šä¸ª Web æœåŠ¡å™¨å…±äº«æ–‡ä»¶å¹¶ä¿æŒæƒé™ä¸€è‡´ï¼Ÿ

**ç­”**ï¼šä½¿ç”¨ `all_squash` + `anonuid/anongid` æ˜ å°„åˆ° `www-data` ç”¨æˆ·ã€‚

```bash
# æœåŠ¡å™¨é…ç½®
/data/share 10.0.4.0/24(rw,sync,all_squash,anonuid=33,anongid=33)

# æ‰€æœ‰å®¢æˆ·ç«¯åˆ›å»ºç›¸åŒçš„ www-data ç”¨æˆ·ï¼ˆUID=33ï¼‰
useradd -u 33 -M www-data

# ä¿®æ”¹å…±äº«ç›®å½•æ‰€æœ‰è€…
chown www-data:www-data /data/share
```

---

### Q4: NFS æ€§èƒ½æ…¢æ€ä¹ˆä¼˜åŒ–ï¼Ÿ

**ç­”**ï¼š

1. **ä½¿ç”¨å¼‚æ­¥å†™å…¥**ï¼š`async`ï¼ˆæå‡ 50-300%ï¼‰
2. **å¢å¤§ç¼“å†²åŒº**ï¼š`rsize=1048576,wsize=1048576`
3. **ç¦ç”¨æ–‡ä»¶é”**ï¼š`nolock`ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
4. **å‡çº§åˆ° NFSv4.1**ï¼šæ”¯æŒå¹¶è¡Œè®¿é—®
5. **ç½‘ç»œä¼˜åŒ–**ï¼šä½¿ç”¨ä¸‡å…†ç½‘å¡ã€å¯ç”¨ Jumbo Frame

---

### Q5: mount æ—¶æç¤º "Stale file handle" æ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼šè¿™æ˜¯å› ä¸º NFS æœåŠ¡å™¨é‡å¯æˆ–å…±äº«ç›®å½•è¢«åˆ é™¤ã€‚

```bash
# å¼ºåˆ¶å¸è½½
umount -f /mnt/nfs

# æˆ–æ‡’å¸è½½
umount -l /mnt/nfs

# é‡æ–°æŒ‚è½½
mount -t nfs 10.0.4.10:/data/share /mnt/nfs
```

---

### Q6: å¦‚ä½•é…ç½®åªè¯»å…±äº«ï¼Ÿ

**ç­”**ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
/data/share 10.0.4.0/24(ro,sync)

exportfs -arv

# å®¢æˆ·ç«¯æŒ‚è½½
mount -t nfs -o ro 10.0.4.10:/data/share /mnt/nfs
```

---

### Q7: å¦‚ä½•é…ç½®ä¸åŒå®¢æˆ·ç«¯ä¸åŒæƒé™ï¼Ÿ

**ç­”**ï¼š

```bash
# /etc/exports é…ç½®
/data/share 10.0.4.11(rw,sync) 10.0.4.12(ro,sync) 10.0.4.13(ro)

exportfs -arv
```

---

## ğŸ“ ç¬¬åä¸€éƒ¨åˆ†ï¼šå­¦ä¹ æ€»ç»“

é€šè¿‡æœ¬ç¯å¢ƒçš„å­¦ä¹ ï¼Œä½ åº”è¯¥æŒæ¡ï¼š

### æ ¸å¿ƒæ¦‚å¿µ

1. **NFS å·¥ä½œåŸç†**ï¼šå®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œè®¿é—®æœåŠ¡å™¨å…±äº«ç›®å½•
2. **Docker Volume å¿…è¦æ€§**ï¼šoverlay æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒ NFS å¯¼å‡º
3. **å…³é”®è¿›ç¨‹**ï¼šrpcbind (111), nfsd (2049), mountd (20048)
4. **NFS ç‰ˆæœ¬**ï¼šNFSv4 æ˜¯ç°ä»£æ¨èç‰ˆæœ¬ï¼ˆTCP, ä»… 2049 ç«¯å£ï¼‰

### é…ç½®æŠ€èƒ½

1. **æœåŠ¡å™¨é…ç½®**ï¼šç¼–è¾‘ `/etc/exports`ï¼Œä½¿ç”¨ `exportfs -arv` å¯¼å‡º
2. **å®¢æˆ·ç«¯æŒ‚è½½**ï¼šä½¿ç”¨ `mount -t nfs` æŒ‚è½½ï¼Œç†è§£æŒ‚è½½é€‰é¡¹
3. **æƒé™æ§åˆ¶**ï¼šç†è§£ root_squash, all_squash, anonuid ç­‰é€‰é¡¹
4. **æŒä¹…åŒ–**ï¼šé…ç½® `/etc/fstab` å®ç°å¼€æœºè‡ªåŠ¨æŒ‚è½½

### æ•…éšœæ’é™¤

1. **does not support NFS export** â†’ ä½¿ç”¨ Docker Volume
2. **access denied** â†’ æ£€æŸ¥ `/etc/exports` å®¢æˆ·ç«¯ IP èŒƒå›´
3. **Permission denied** â†’ æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™å’Œ NFS æƒé™
4. **Connection timed out** â†’ æ£€æŸ¥ç½‘ç»œå’Œç«¯å£
5. **Stale file handle** â†’ å¼ºåˆ¶å¸è½½åé‡æ–°æŒ‚è½½

### å®æˆ˜åº”ç”¨

1. **Web é›†ç¾¤å…±äº«**ï¼šå¤šä¸ª Web æœåŠ¡å™¨å…±äº«é™æ€æ–‡ä»¶
2. **å®¹å™¨æŒä¹…åŒ–**ï¼šKubernetes PV ä½¿ç”¨ NFS åç«¯
3. **å¼€å‘ç¯å¢ƒ**ï¼šå¤šä¸ªå¼€å‘è€…å…±äº«ä»£ç ç›®å½•
4. **å¤‡ä»½ç³»ç»Ÿ**ï¼šé›†ä¸­å­˜å‚¨å¤‡ä»½æ•°æ®

---

## ğŸ§¹ æ¸…ç†ç¯å¢ƒ

```bash
# 1. å®¢æˆ·ç«¯å¸è½½æŒ‚è½½
docker compose exec nfs-client umount /mnt/nfs

# 2. åœæ­¢æ‰€æœ‰å®¹å™¨
docker compose down

# 3. åˆ é™¤ Volumeï¼ˆå¯é€‰ï¼Œä¼šåˆ é™¤æ•°æ®ï¼‰
docker compose down --volumes

# 4. å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬é•œåƒï¼‰
docker compose down --volumes --rmi all
```

---

## ğŸ“– å‚è€ƒèµ„æ–™

- **NFS å®˜æ–¹æ–‡æ¡£**: https://linux-nfs.org/
- **NFS man æ‰‹å†Œ**: `man nfs`, `man exports`, `man mount.nfs`
- **RFC 1813**: NFSv3 åè®®è§„èŒƒ
- **RFC 7530**: NFSv4 åè®®è§„èŒƒ
- **Docker Volume æ–‡æ¡£**: https://docs.docker.com/storage/volumes/

---

## ğŸ”— ç›¸å…³é¡¹ç›®

- **04.nfs/01.manual-nfs**: æœ¬é¡¹ç›®ï¼ˆæ‰‹åŠ¨é…ç½® NFSï¼‰
- **03.rsyslog**: æ—¥å¿—ç®¡ç†å®è·µ
- **05.dns**: DNS æœåŠ¡é…ç½®

---

**å®Œæˆæ—¶é—´**: 2025-10-09
**æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆè§„èŒƒåŒ–ç‰ˆæœ¬ï¼‰
**ç»´æŠ¤è€…**: docker-man é¡¹ç›®ç»„
